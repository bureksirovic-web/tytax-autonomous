# Vulnerability & Stability Report

**Date:** October 26, 2023
**Target:** Tytax Elite v3.1 (`index.html`)
**Scope:** Stability, Data Integrity, and Input Validation

## Executive Summary
The application is generally stable for day-to-day use but contains **three critical stability vulnerabilities** related to data persistence and input handling. The most severe issue allows a malformed import file to permanently crash the application (Persistent Denial of Service), requiring a complete data wipe to recover. Additionally, long-term usage (approx. 9-10 years) will inevitably hit browser storage limits, causing silent save failures or crashes.

---

## 1. Persistent Denial of Service via JSON Import (Critical)

**Description:**
The application's `importJSON` logic validates the *existence* of keys (e.g., `logs`, `sessionOrder`) but fails to validate their *data types*. If a user imports a JSON file where `logs` is defined as a String or Object instead of an Array, the application accepts it, updates the state, and immediately persists it to `localStorage`.

Upon the next render or page reload, the application attempts to iterate over `logs` (using `.map()` or `.filter()`). Since `logs` is now a String/Object, this throws a JavaScript Error (`TypeError: logs.map is not a function`). Because the corrupted state is saved in `localStorage`, reloading the page triggers the same crash loop.

**Impact:**
*   **Permanent Crash:** The app becomes unusable.
*   **Data Loss:** The only way to recover is to clear the browser's local storage/cookies, which deletes all legitimate user history.

**Reproduction (PoC):**
1.  Create a file named `poc_crash.json` with the following content:
    ```json
    {
      "logs": "MALICIOUS_PAYLOAD_NOT_AN_ARRAY",
      "sessionOrder": ["Upper A", "Lower A"]
    }
    ```
2.  Open the "Master Node" (Settings) tab.
3.  Click "Import" and select `poc_crash.json`.
4.  **Result:** The application will immediately crash (white screen) or crash upon reloading the page.

**Recommendation:**
*   Implement strict type checking in `importJSON` and `onFileChange`.
*   Ensure `Array.isArray(d.logs)` is true before accepting the data.
*   Wrap `localStorage.setItem` calls in a safety handler that prevents saving if the state is invalid.

---

## 2. Storage Quota Exceeded Crash (High)

**Description:**
The application relies entirely on `localStorage`, which typically has a **5MB limit** in most browsers.
*   **Growth Rate:** Based on the current schema and 3 sessions/week, the app generates ~0.54 MB of data per year.
*   **Time to Failure:** Approximately 9-10 years of history.
*   **Issue:** The `useEffect` hooks responsible for saving data do not wrap `localStorage.setItem` in a `try/catch` block.

**Impact:**
*   **Silent Failure / Freeze:** When the limit is reached, `localStorage.setItem` throws a `QuotaExceededError`. This unhandled exception will likely break the React lifecycle, preventing the "Terminate Session" action from completing or freezing the UI. Users may believe their workout is saved when it is not.

**Recommendation:**
*   Implement a `safeStorage` helper function to handle `QuotaExceededError` gracefully.
*   Add a compression algorithm (e.g., LZ-string) for `logs` before saving.
*   Warn the user when storage usage exceeds 80% (4MB).

---

## 3. CSV Injection & Malformatting (Medium)

**Description:**
The `exportCSV` function constructs CSV rows using manual string concatenation: `"${e.name}"`. It does not escape double quotes that may appear *inside* user-generated content (e.g., an exercise named `Bench "Press"`).

**Impact:**
*   **Corrupted Exports:** A single quote in a note or title can break the CSV structure, making it unreadable in Excel/Sheets.
*   **Formula Injection:** If a user inputs a note starting with `=`, `+`, `-`, or `@`, it could be executed as a formula when opened in Excel (CSV Injection).

**Recommendation:**
*   Sanitize fields: Replace inner `"` with `""` (standard CSV escape).
*   Prepend `'` to fields starting with formula characters to force them as text.

---

## 4. Missing "Empty State" Handling (Low)

**Description:**
The `App` component assumes `masterExercises` is always populated after the initial load. If `tytax_master_exercises` in `localStorage` becomes an empty array (e.g., via a bad sync or clear), the app may render blank cards or fail to look up impact metrics.

**Impact:**
*   Degraded UX (Empty Builder, missing impact charts).

**Recommendation:**
*   Add a fallback to reload default `PRESETS` if `masterExercises` is empty on mount.
