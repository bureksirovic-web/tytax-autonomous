<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tytax T1 Elite Companion - v3.1</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap'); 
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; } 
        select { -webkit-appearance: none; appearance: none; cursor: pointer; } 
        .tab-content { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); } 
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } } 
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); } 
        .timer-progress { transition: width 1s linear; } 
        .accent-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); } 
        .status-pulse { animation: pulse 2s infinite; } 
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } } 
        .glow-indigo { box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); } 
        .glow-yellow { box-shadow: 0 0 20px rgba(234, 179, 8, 0.2); }
    </style> 
</head> 
<body> 
    <div id="root"></div> 
 
    <script type="text/babel"> 
        const { useState, useEffect, useMemo, useRef } = React; 
 
        // --- ICONS --- 
        const ICONS = { 
            home: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>, 
            dumbbell: <path d="M14.4 14.4 9.6 9.6M18.657 21.485l-2.828-2.828M4.172 7l-2.829-2.828M6.343 4.828 3.515 2M22 17.657l-2.828-2.828M6.343 19.172 4.929 17.757M19.172 6.343l-1.415-1.414M17.757 4.929l-1.414-1.415M4.929 6.343l-1.414-1.414M17.657 22l-2.828-2.828M2 6.343l2.828 2.828M21.485 18.657l-2.828-2.828M11.5 15.5l-4-4M16.5 12.5l-4-4" />, 
            trends: <><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></>, 
            check: <polyline points="20 6 9 17 4 12" />, 
            history: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5M12 7v5l4 2" /></>, 
            settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>, 
            x: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>, 
            timer: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>, 
            play: <polygon points="5 3 19 12 5 21 5 3" />, 
            library: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 4.5A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5v-15z" />, 
            tool: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />, 
            info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>, 
            bolt: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />, 
            shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />,
            shuffle: <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" />,
            trash: <path d="M3 6H5H21M19 6V20C19 21 18 22 17 22H7C6 22 5 21 5 20V6M8 6V4C8 3 9 2 10 2H14C15 2 16 3 16 4V6" />
        };

        const Icon = ({ name, className = "w-5 h-5" }) => { 
            return ( 
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}> 
                    {ICONS[name] || <circle cx="12" cy="12" r="10" />} 
                </svg> 
            ); 
        }; 
 
        // --- HELPER FUNCTIONS ---
        const normalizeStationName = (name) => {
            const n = name.toLowerCase();
            if (n.includes('smith')) return 'SMITH';
            if (n.includes('upper pulley') || n.includes('lat station')) return 'BACK_UPPER';
            if (n.includes('lower pulley') || n.includes('row station')) return 'BACK_LOWER';
            if (n.includes('extension')) return 'LEG_EXTENSION';
            if (n.includes('curl')) return 'LEG_CURL';
            return 'OTHER';
        };

        const normalizeMuscleName = (name) => {
            if (!name) return 'Other';
            const n = name.toUpperCase().trim();
            
            // MAP USER JSON KEYS -> SYSTEM KEYS
            if (n.includes('CHEST') || n.includes('PECTORALIS')) return 'Chest';
            if (n.includes('LATISSIMUS') || n.includes('LATS') || n.includes('BACK - VERTICAL')) return 'Lats';
            if (n.includes('TRAPEZIUS') || n.includes('RHOMBOIDS') || n.includes('BACK - HORIZONTAL')) return 'Mid Back';
            if (n.includes('ANTERIOR DELT') || n.includes('FRONT DELT')) return 'Front Delts';
            if (n.includes('LATERAL DELT') || n.includes('SIDE DELT')) return 'Side Delts';
            if (n.includes('POSTERIOR DELT') || n.includes('REAR DELT')) return 'Rear Delts';
            if (n.includes('DELTOID') || n.includes('SHOULDER')) return 'Delts';
            if (n.includes('BICEPS')) return 'Biceps';
            if (n.includes('TRICEPS')) return 'Triceps';
            if (n.includes('QUADRICEPS') || n.includes('QUADS')) return 'Quads';
            if (n.includes('HAMSTRINGS')) return 'Hamstrings';
            if (n.includes('GLUTE') || n.includes('GLUTEUS')) return 'Glutes';
            if (n.includes('CALVES') || n.includes('GASTROCNEMIUS') || n.includes('SOLEUS')) return 'Calves';
            if (n.includes('RECTUS ABDOMINIS') || n.includes('OBLIQUES') || n.includes('CORE')) return 'Core';
            if (n.includes('FOREARM') || n.includes('GRIP')) return 'Forearms';

            // Fallback: Capitalize first letter
            return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        };

        const getImpact = (exercise) => {
            // Check for v2.1 structured impact (Array)
            if (exercise.impact && Array.isArray(exercise.impact)) {
                return exercise.impact.map(i => ({ 
                    muscle: normalizeMuscleName(i.m), 
                    score: i.s,
                    level: i.s >= 90 ? 'Primary' : i.s >= 50 ? 'Secondary' : 'Tertiary' 
                }));
            }
            // Check for v3.0 structured impact (Object)
            if (exercise.impact && typeof exercise.impact === 'object') {
                 return Object.entries(exercise.impact).map(([k, v]) => ({
                     muscle: normalizeMuscleName(k),
                     score: v,
                     level: v >= 90 ? 'Primary' : v >= 50 ? 'Secondary' : 'Tertiary'
                 }));
            }
            // Fallback to old string-based note parsing
            return parseImpact(exercise.note); 
        };

        const getProjectedImpact = (exercises) => {
            const impact = {};
            exercises.forEach(ex => {
                // Use robust helper for all data formats (V2 Array, V3 Object, or Notes)
                const impactData = getImpact(ex); 
                
                const multiplier = ex.unilateral ? 2 : 1; // Double volume for unilateral
                
                impactData.forEach(i => {
                    const name = normalizeMuscleName(i.muscle);
                    const score = i.score * multiplier;
                    impact[name] = (impact[name] || 0) + score;
                });
            });
            
            // Normalize to percentage for the bar chart
            const max = Math.max(...Object.values(impact), 1);
            return Object.entries(impact)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6) // Top 6 muscles only
                .map(([m, s]) => ({ muscle: m, pct: (s / max) * 100 }));
        };

        const parseImpact = (note) => {
            if (!note) return [];
            const impacts = [];
            
            // New logic: Split by semicolon and parse each segment flexibly
            const segments = note.split(';');
            segments.forEach(segment => {
                const cleanSeg = segment.trim();
                // Regex to find "Primary", "Secondary", or "Tertiary" (case insensitive)
                const levelMatch = cleanSeg.match(/(Primary|Secondary|Tertiary)/i);
                // Regex to find the score (digits)
                const scoreMatch = cleanSeg.match(/(\d+)/);
                
                if (levelMatch && scoreMatch) {
                    // Extract muscle name: remove level, score, special chars like ~
                    let muscle = cleanSeg
                        .replace(levelMatch[0], '')
                        .replace(scoreMatch[0], '')
                        .replace(/[~>]/g, '')
                        .replace(/keep it light\/clean/i, '') // Specific cleanup for known noisy notes
                        .trim();
                    
                    if (muscle) {
                        impacts.push({
                            level: levelMatch[0],
                            score: parseInt(scoreMatch[0]),
                            muscle: muscle.toLowerCase()
                        });
                    }
                }
            });
            
            return impacts;
        };

        const cleanName = (name) => {
            return name
                .replace(/TYTAXÂ® T1-X(\-\d+)?\s*\|\s*/g, '')
                .replace(/Instruction\s*\|\s*/g, '')
                .replace(/\s+/g, ' ').trim();
        };

        const calculateE1RM = (kg, reps) => {
            if (!kg || !reps) return 0;
            const w = parseFloat(kg);
            const r = parseFloat(reps);
            // Brzycki Formula (Standard) - Fallback to Epley for high reps to prevent infinity/negative
            if (r >= 37) return Math.round(w * (1 + r / 30));
            return Math.round(w * (36 / (37 - r)));
        };

        const getLastMaxLoad = (exerciseName, logs) => {
            const history = logs.filter(l => l.exercises.some(e => e.name === exerciseName));
            if (!history.length) return 0;
            
            // Find the most recent log for this exercise
            const lastLog = history[0]; // logs are sorted desc in App state
            const exercise = lastLog.exercises.find(e => e.name === exerciseName);
            
            if (!exercise) return 0;
            
            // Calculate max load from working sets
            const maxLoad = Math.max(...exercise.sets.map(s => {
                // If type is present, exclude warmups. If not (legacy), assume working.
                if (s.type === 'warmup') return 0;
                return parseFloat(s.kg) || 0;
            }));
            
            return maxLoad > 0 ? maxLoad : 0;
        };

        const calculateImpactDistribution = (exercises, countSets = false) => {
            const impact = {};
            exercises.forEach(ex => {
                let multiplier = countSets 
                    ? (ex.sets ? ex.sets.filter(s => s.done || (s.kg && s.reps)).length : 1)
                    : 1;
                
                if (ex.unilateral) multiplier *= 2;

                if (multiplier > 0) {
                    const parsed = getImpact(ex);
                    parsed.forEach(p => {
                        impact[p.muscle] = (impact[p.muscle] || 0) + (p.score * multiplier);
                    });
                }
            });
            
            const values = Object.values(impact);
            const max = values.length ? Math.max(...values) : 1;
            
            return Object.entries(impact)
                .sort((a, b) => b[1] - a[1])
                .map(([m, s]) => ({ muscle: m, score: s, pct: (s / max) * 100 }));
        };

        const generateWarmups = (lastMax, strategy = 'Standard') => {
            if (!lastMax || lastMax <= 0) return [];
            
            if (strategy === 'Heavy') {
                return [
                    { kg: (lastMax * 0.50).toFixed(1), reps: 10, rir: '', done: false, type: 'warmup' },
                    { kg: (lastMax * 0.75).toFixed(1), reps: 5, rir: '', done: false, type: 'warmup' },
                    { kg: (lastMax * 0.85).toFixed(1), reps: 3, rir: '', done: false, type: 'warmup' },
                    { kg: (lastMax * 0.95).toFixed(1), reps: 1, rir: '', done: false, type: 'warmup' }
                ];
            }
            if (strategy === 'Pyramid') {
                 return [
                    { kg: (lastMax * 0.40).toFixed(1), reps: 12, rir: '', done: false, type: 'warmup' },
                    { kg: (lastMax * 0.60).toFixed(1), reps: 8, rir: '', done: false, type: 'warmup' },
                    { kg: (lastMax * 0.80).toFixed(1), reps: 4, rir: '', done: false, type: 'warmup' }
                ];
            }
            return [
                { kg: (lastMax * 0.50).toFixed(1), reps: 10, rir: '', done: false, type: 'warmup' },
                { kg: (lastMax * 0.75).toFixed(1), reps: 5, rir: '', done: false, type: 'warmup' }
            ];
        };

        const getAttachment = (exerciseName, presets) => {
            const preset = presets.find(p => p.id === 'kinetic_impact');
            if (!preset || !preset.data.RECOMMENDED_ATTACHMENTS) return null;
            
            const attachments = preset.data.RECOMMENDED_ATTACHMENTS;
            const name = exerciseName.toLowerCase();
            
            if (name.includes('rope')) return attachments.find(a => a.name.toLowerCase().includes('rope'));
            if (name.includes('v-bar') || name.includes('v-handle')) return attachments.find(a => a.name.toLowerCase().includes('v-handle'));
            if (name.includes('straight bar')) return attachments.find(a => a.name.toLowerCase().includes('straight bar'));
            if (name.includes('single') || name.includes('one-arm')) return attachments.find(a => a.name.toLowerCase().includes('d-handles'));
            if (name.includes('ankle') || name.includes('kickback')) return attachments.find(a => a.name.toLowerCase().includes('ankle'));
            if (name.includes('belt')) return attachments.find(a => a.name.toLowerCase().includes('belt'));
            
            return null;
        };

        const getLaggingMuscle = (logs, masterExercises) => {
            if (!logs.length) return null;
        
            // 1. Calculate Protocol Ideal (Global)
            const protocolDist = calculateImpactDistribution(masterExercises, false);
        
            // 2. Calculate Actual (Last 7 Days)
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const recentLogs = logs.filter(l => new Date(l.date) > sevenDaysAgo);
        
            // Flatten all exercises from recent logs
            const allRecentExercises = recentLogs.flatMap(l => l.exercises);
            const actualDist = calculateImpactDistribution(allRecentExercises, true);
        
            // 3. Find largest negative delta
            // We compare the rank/presence. If a muscle is high in Protocol but low in Actual.
            // Simplified: Compare pct vs pct.
            let maxGap = 0;
            let laggingMuscle = null;
        
            protocolDist.forEach(proto => {
                const actual = actualDist.find(a => a.muscle === proto.muscle);
                const actualPct = actual ? actual.pct : 0;
                const gap = proto.pct - actualPct;
        
                if (gap > maxGap && gap > 30) { // Threshold of 30% gap
                    maxGap = gap;
                    laggingMuscle = proto.muscle;
                }
            });
        
            return laggingMuscle;
        };

        // --- PRESETS --- 
        const PRESETS = [ 
            { 
                id: "kinetic_impact", 
                name: "Tytax Elite v3.0 (Fixed 6/1 Split)", 
                description: "Official 6/1 Kinetic Load protocol updated for v3.0 library.", 
                data: {
                  "MUSCLE_GROUPS": [
  {
    "key": "CHEST",
    "name": "Chest (Pectoralis Major/Minor)",
    "details": {
      "subregions": [
        "Upper (clavicular)",
        "Mid (sternal)",
        "Lower (costal)"
      ],
      "functions": [
        "Horizontal adduction",
        "Shoulder flexion (upper bias)",
        "Shoulder extension from flexion (lower bias)"
      ],
      "common_patterns": [
        "Horizontal Press",
        "Cable Fly (single-arm or dual)"
      ]
    }
  },
  {
    "key": "BACK_VERTICAL",
    "name": "Back - Vertical Pull (Lats Focus)",
    "details": {
      "subregions": [
        "Lats",
        "Teres major",
        "Scapular depressors"
      ],
      "functions": [
        "Shoulder adduction/extension",
        "Scapular depression",
        "Elbow flexion synergy"
      ],
      "common_patterns": [
        "Lat Pulldown variations",
        "Straight-arm pulldown / pullover"
      ]
    }
  },
  {
    "key": "BACK_HORIZONTAL",
    "name": "Back - Horizontal Pull (Mid-Back Focus)",
    "details": {
      "subregions": [
        "Rhomboids",
        "Mid traps",
        "Rear delts"
      ],
      "functions": [
        "Scapular retraction",
        "Horizontal pulling",
        "Postural control"
      ],
      "common_patterns": [
        "Seated rows",
        "Smith rows",
        "One-arm rows"
      ]
    }
  },
  {
    "key": "SHOULDERS",
    "name": "Shoulders (Deltoids + Scapular Control)",
    "details": {
      "subregions": [
        "Anterior delts",
        "Lateral delts",
        "Posterior delts",
        "Rotator cuff (stability)"
      ],
      "functions": [
        "Vertical pressing",
        "Abduction",
        "External rotation/stability"
      ],
      "common_patterns": [
        "Smith press",
        "Cable raises",
        "Face pulls / rear delt work"
      ]
    }
  },
  {
    "key": "BICEPS",
    "name": "Biceps & Elbow Flexors",
    "details": {
      "subregions": [
        "Biceps brachii",
        "Brachialis",
        "Brachioradialis"
      ],
      "functions": [
        "Elbow flexion",
        "Supination (biceps)",
        "Grip synergy"
      ],
      "common_patterns": [
        "Cable curls (low/high)",
        "Hammer / reverse variations"
      ]
    }
  },
  {
    "key": "TRICEPS",
    "name": "Triceps & Elbow Extensors",
    "details": {
      "subregions": [
        "Long head",
        "Lateral head",
        "Medial head"
      ],
      "functions": [
        "Elbow extension",
        "Shoulder extension stability (long head)"
      ],
      "common_patterns": [
        "Pushdowns",
        "Overhead extensions",
        "Press variations (close-grip/JM)"
      ]
    }
  },
  {
    "key": "FOREARMS_GRIP",
    "name": "Forearms & Grip",
    "details": {
      "subregions": [
        "Wrist flexors",
        "Wrist extensors",
        "Pronators/supinators"
      ],
      "functions": [
        "Grip endurance",
        "Wrist control",
        "Elbow/hand stability"
      ],
      "common_patterns": [
        "Cable wrist work",
        "Static holds",
        "Reverse curls"
      ]
    }
  },
  {
    "key": "QUADS",
    "name": "Quads (Knee Extension Dominant)",
    "details": {
      "subregions": [
        "Vastus lateralis/medialis/intermedius",
        "Rectus femoris"
      ],
      "functions": [
        "Knee extension",
        "Squat/leg press drive"
      ],
      "common_patterns": [
        "Smith squat variations",
        "Leg press variants",
        "Leg extensions"
      ]
    }
  },
  {
    "key": "HAMSTRINGS",
    "name": "Hamstrings (Knee Flexion + Hip Hinge)",
    "details": {
      "subregions": [
        "Biceps femoris",
        "Semitendinosus",
        "Semimembranosus"
      ],
      "functions": [
        "Knee flexion",
        "Hip extension synergy",
        "Posterior-chain tension"
      ],
      "common_patterns": [
        "RDL/hinge",
        "Leg curls (seat/cable)",
        "Pull-through"
      ]
    }
  },
  {
    "key": "GLUTES",
    "name": "Glutes (Hip Extension / Shape & Power)",
    "details": {
      "subregions": [
        "Glute max",
        "Glute med/min (stability)"
      ],
      "functions": [
        "Hip extension",
        "Pelvic control",
        "Abduction synergy"
      ],
      "common_patterns": [
        "Hip thrust/bridge",
        "Glute-biased squats/lunges",
        "Kickbacks"
      ]
    }
  },
  {
    "key": "CALVES",
    "name": "Calves (Plantarflexors)",
    "details": {
      "subregions": [
        "Gastrocnemius",
        "Soleus"
      ],
      "functions": [
        "Plantarflexion",
        "Ankle stiffness",
        "Gait/hiking support"
      ],
      "common_patterns": [
        "Standing/seated raises",
        "Leg-press calf press",
        "Single-leg work"
      ]
    }
  },
  {
    "key": "CORE",
    "name": "Core (Trunk Strength & Stability)",
    "details": {
      "subregions": [
        "Abs (anti-extension)",
        "Obliques (anti-rotation)",
        "Spinal erectors (posterior support)"
      ],
      "functions": [
        "Bracing",
        "Anti-rotation",
        "Pelvic control"
      ],
      "common_patterns": [
        "Cable crunch",
        "Pallof press",
        "Woodchops/rotations",
        "Loaded carries/holds"
      ]
    }
  }
],
                  "STATIONS": [
  {
    "key": "SMITH",
    "name": "Smith Machine",
    "notes": "High stability, fixed bar path. Great for beginners and consistent tension."
  },
  {
    "key": "BACK_UPPER",
    "name": "Back Upper Pulley (either back station)",
    "notes": "Constant tension. Use for pulldowns, face pulls, pushdowns, crunches."
  },
  {
    "key": "BACK_LOWER",
    "name": "Back Lower Pulley (station with lower pulley)",
    "notes": "Constant tension. Use for rows, curls, pull-throughs, wrist work."
  },
  {
    "key": "LEG_EXTENSION",
    "name": "Seated Leg Extension",
    "notes": "Knee extension isolation."
  },
  {
    "key": "LEG_CURL",
    "name": "Seated Leg Curl",
    "notes": "Knee flexion isolation."
  }
],
                  "RECOMMENDED_ATTACHMENTS": [
  {
    "name": "Pair of single D-handles",
    "priority": "High",
    "why": "Unlocks single-arm presses/rows/curls/raises; best for symmetry and shoulder comfort."
  },
  {
    "name": "Triceps rope",
    "priority": "High",
    "why": "Best for pushdowns, face pulls, overhead extensions."
  },
  {
    "name": "Short straight bar (cable bar)",
    "priority": "High",
    "why": "Curls, pushdowns, wrist curls, straight-arm pulldowns."
  },
  {
    "name": "V-handle / close-grip row handle",
    "priority": "High",
    "why": "Neutral-grip pulldowns and close rows."
  },
  {
    "name": "Ankle strap",
    "priority": "High",
    "why": "Glute kickbacks, hip abduction/adduction, standing ham curls."
  },
  {
    "name": "Ab strap (cable crunch strap)",
    "priority": "Medium",
    "why": "More comfortable heavy cable crunches than holding a bar."
  },
  {
    "name": "Lat bar (you already have)",
    "priority": "Owned",
    "why": "Wide/standard pulldown and straight-arm pulldown patterns."
  },
  {
    "name": "EZ/angled lat bar (you already have)",
    "priority": "Owned",
    "why": "Comfort grip variations; good for underhand/angled pulldowns."
  },
  {
    "name": "Dip belt or strong assistance band",
    "priority": "Optional",
    "why": "If you want assisted pull-ups using the Smith bar setup."
  }
],
                  "MASTER_EXERCISES": [
  {
    "name": "TYTAX T1 | Smith Flat Bench Press",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Chest (sternal pec)",
        "s": 95
      },
      {
        "m": "Triceps",
        "s": 65
      },
      {
        "m": "Front Delts",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Incline Bench Press",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Upper Chest (clavicular pec)",
        "s": 95
      },
      {
        "m": "Front Delts",
        "s": 65
      },
      {
        "m": "Triceps",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Decline Bench Press",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lower Chest (costal pec)",
        "s": 94
      },
      {
        "m": "Triceps",
        "s": 65
      },
      {
        "m": "Front Delts",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Spoto Press (pause on chest)",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 2,
    "reps": "6-10",
    "impact": [
      {
        "m": "Chest (sternal pec)",
        "s": 93
      },
      {
        "m": "Triceps",
        "s": 60
      },
      {
        "m": "Front Delts",
        "s": 30
      }
    ],
    "note": "Great for control; use lighter load"
  },
  {
    "name": "TYTAX T1 | Smith Floor Press",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Triceps",
        "s": 92
      },
      {
        "m": "Chest (sternal pec)",
        "s": 75
      },
      {
        "m": "Front Delts",
        "s": 25
      }
    ],
    "note": "Shorter ROM; shoulder-friendly"
  },
  {
    "name": "TYTAX T1 | Smith Close-Grip Bench Press",
    "station": "Smith Machine",
    "muscle_group": "CHEST",
    "pattern": "Horizontal Press",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Chest (sternal pec)",
        "s": 60
      },
      {
        "m": "Front Delts",
        "s": 25
      }
    ],
    "note": "Chest still involved, but triceps usually limit"
  },
  {
    "name": "TYTAX T1 | Upper Pulley Single-Arm Standing Chest Press",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CHEST",
    "pattern": "Cable Press",
    "unilateral": true,
    "sets": 3,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Chest (sternal pec)",
        "s": 93
      },
      {
        "m": "Triceps",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Standing Chest Press",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CHEST",
    "pattern": "Cable Press",
    "unilateral": true,
    "sets": 3,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Chest (sternal pec)",
        "s": 93
      },
      {
        "m": "Triceps",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley High-to-Low Single-Arm Cable Fly",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CHEST",
    "pattern": "Cable Fly",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Lower Chest bias",
        "s": 92
      },
      {
        "m": "Front Delts",
        "s": 55
      },
      {
        "m": "Biceps (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Low-to-High Single-Arm Cable Fly",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CHEST",
    "pattern": "Cable Fly",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Upper Chest bias",
        "s": 92
      },
      {
        "m": "Front Delts",
        "s": 55
      },
      {
        "m": "Biceps (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Wide-Grip Lat Pulldown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lats",
        "s": 95
      },
      {
        "m": "Mid/Lower Traps + Rhomboids",
        "s": 60
      },
      {
        "m": "Biceps",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Close-Grip Lat Pulldown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lats",
        "s": 95
      },
      {
        "m": "Mid/Lower Traps + Rhomboids",
        "s": 58
      },
      {
        "m": "Biceps",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Underhand Lat Pulldown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lats",
        "s": 93
      },
      {
        "m": "Biceps",
        "s": 75
      },
      {
        "m": "Mid/Lower Traps + Rhomboids",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Neutral-Grip Lat Pulldown (V-handle)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lats",
        "s": 95
      },
      {
        "m": "Mid/Lower Traps + Rhomboids",
        "s": 55
      },
      {
        "m": "Biceps",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Single-Arm Kneeling Lat Pulldown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Lats",
        "s": 94
      },
      {
        "m": "Mid/Lower Traps + Rhomboids",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Straight-Arm Lat Pulldown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Pullover / Shoulder Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Lats",
        "s": 94
      },
      {
        "m": "Serratus/Scapular depressors",
        "s": 55
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Lat Pullover (slight elbow bend)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Pullover / Shoulder Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Lats",
        "s": 92
      },
      {
        "m": "Serratus/Scapular control",
        "s": 55
      },
      {
        "m": "Biceps (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Rope Pulldown (elbows-in)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Vertical Pull",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Lats",
        "s": 92
      },
      {
        "m": "Rear Delts",
        "s": 55
      },
      {
        "m": "Biceps",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Inverted Row (overhand, feet elevated option)",
    "station": "Smith Machine",
    "muscle_group": "BACK_VERTICAL",
    "pattern": "Bodyweight Pull (horizontal)",
    "unilateral": false,
    "sets": 3,
    "reps": "8-15",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 92
      },
      {
        "m": "Lats",
        "s": 65
      },
      {
        "m": "Biceps",
        "s": 40
      }
    ],
    "note": "Counts as pull pattern; adjust body angle for difficulty"
  },
  {
    "name": "TYTAX T1 | Lower Pulley Seated Cable Row (bench)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 95
      },
      {
        "m": "Lats",
        "s": 70
      },
      {
        "m": "Biceps",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Wide-Grip Seated Cable Row",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 94
      },
      {
        "m": "Rear Delts",
        "s": 65
      },
      {
        "m": "Biceps",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Underhand Seated Cable Row",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Lats",
        "s": 92
      },
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 70
      },
      {
        "m": "Biceps",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley One-Arm Seated Cable Row",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 93
      },
      {
        "m": "Lats",
        "s": 65
      },
      {
        "m": "Core (anti-rotation)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Standing One-Arm Cable Row",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Lats",
        "s": 92
      },
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 65
      },
      {
        "m": "Core (anti-rotation)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley High Cable Row (to chest, elbows out)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "10-15",
    "impact": [
      {
        "m": "Upper/Mid Back (rhomboids/mid traps)",
        "s": 93
      },
      {
        "m": "Rear Delts",
        "s": 70
      },
      {
        "m": "Biceps",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Bent-Over Row",
    "station": "Smith Machine",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 93
      },
      {
        "m": "Lats",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Pendlay-Style Row (from dead stop)",
    "station": "Smith Machine",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 2,
    "reps": "6-10",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 92
      },
      {
        "m": "Lats",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 40
      }
    ],
    "note": "Use lighter load; strict form"
  },
  {
    "name": "TYTAX T1 | Lower Pulley Chest-Supported Row (bench incline)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 94
      },
      {
        "m": "Lats",
        "s": 65
      },
      {
        "m": "Biceps",
        "s": 35
      }
    ],
    "note": "Bench support reduces low-back fatigue"
  },
  {
    "name": "TYTAX T1 | Lower Pulley Rope Row (elbows high for rear delts)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BACK_HORIZONTAL",
    "pattern": "Horizontal Pull",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Rear Delts",
        "s": 92
      },
      {
        "m": "Mid Back (rhomboids/mid traps)",
        "s": 65
      },
      {
        "m": "Biceps",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Seated Shoulder Press",
    "station": "Smith Machine",
    "muscle_group": "SHOULDERS",
    "pattern": "Vertical Press",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Delts (anterior/medial)",
        "s": 95
      },
      {
        "m": "Triceps",
        "s": 65
      },
      {
        "m": "Upper Traps/Scapular stabilizers",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Standing Overhead Press",
    "station": "Smith Machine",
    "muscle_group": "SHOULDERS",
    "pattern": "Vertical Press",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Delts (anterior/medial)",
        "s": 94
      },
      {
        "m": "Triceps",
        "s": 65
      },
      {
        "m": "Core (bracing)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Lateral Raise",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "SHOULDERS",
    "pattern": "Lateral Raise",
    "unilateral": true,
    "sets": 3,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Side Delts",
        "s": 95
      },
      {
        "m": "Supraspinatus",
        "s": 55
      },
      {
        "m": "Upper Traps",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Lean-Away Lateral Raise",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "SHOULDERS",
    "pattern": "Lateral Raise",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Side Delts",
        "s": 96
      },
      {
        "m": "Supraspinatus",
        "s": 55
      },
      {
        "m": "Upper Traps",
        "s": 20
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Front Raise",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "SHOULDERS",
    "pattern": "Front Raise",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Front Delts",
        "s": 95
      },
      {
        "m": "Upper Chest",
        "s": 55
      },
      {
        "m": "Serratus/Scapular stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Face Pull (rope)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "SHOULDERS",
    "pattern": "Scapular / Rear Delt",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Rear Delts",
        "s": 93
      },
      {
        "m": "Mid/Lower Traps",
        "s": 70
      },
      {
        "m": "Rotator Cuff (external rotators)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Rear Delt Fly (single-arm)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "SHOULDERS",
    "pattern": "Rear Delt Isolation",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Rear Delts",
        "s": 92
      },
      {
        "m": "Mid Traps + Rhomboids",
        "s": 65
      },
      {
        "m": "Rotator Cuff",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Y-Raise (scapular plane)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "SHOULDERS",
    "pattern": "Lower Trap / Scapular Control",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Lower Traps",
        "s": 92
      },
      {
        "m": "Side Delts",
        "s": 60
      },
      {
        "m": "Rotator Cuff",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley External Rotation (elbow tucked)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "SHOULDERS",
    "pattern": "Rotator Cuff",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Rotator Cuff (external rotators)",
        "s": 92
      },
      {
        "m": "Rear Delts",
        "s": 55
      },
      {
        "m": "Mid Traps (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Upright Row (range-limited)",
    "station": "Smith Machine",
    "muscle_group": "SHOULDERS",
    "pattern": "Upright Row",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Side Delts",
        "s": 90
      },
      {
        "m": "Upper Traps",
        "s": 70
      },
      {
        "m": "Biceps",
        "s": 25
      }
    ],
    "note": "Keep elbows below shoulder height if shoulder sensitive"
  },
  {
    "name": "TYTAX T1 | Lower Pulley Standing Cable Curl (straight bar)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Biceps",
        "s": 95
      },
      {
        "m": "Brachialis",
        "s": 65
      },
      {
        "m": "Forearms/Grip",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Cable Curl",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Curl",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Biceps",
        "s": 95
      },
      {
        "m": "Brachialis",
        "s": 60
      },
      {
        "m": "Core (anti-rotation)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Rope Hammer Curl",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Hammer Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Brachialis/Brachioradialis",
        "s": 95
      },
      {
        "m": "Biceps",
        "s": 65
      },
      {
        "m": "Forearms/Grip",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Reverse Curl (straight bar)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Reverse Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Brachioradialis",
        "s": 92
      },
      {
        "m": "Biceps",
        "s": 55
      },
      {
        "m": "Wrist Extensors",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley High Cable Curl (D-handles)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "BICEPS",
    "pattern": "High Cable Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Biceps",
        "s": 95
      },
      {
        "m": "Brachialis",
        "s": 60
      },
      {
        "m": "Rear Delts (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Seated Cable Curl (bench)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Biceps",
        "s": 95
      },
      {
        "m": "Brachialis",
        "s": 60
      },
      {
        "m": "Forearms/Grip",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Preacher Curl (bench support)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Preacher Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Biceps",
        "s": 96
      },
      {
        "m": "Brachialis",
        "s": 55
      },
      {
        "m": "Forearms/Grip",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Bayesian Curl (cable behind body)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "BICEPS",
    "pattern": "Bayesian Curl",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Biceps (long head bias)",
        "s": 96
      },
      {
        "m": "Brachialis",
        "s": 55
      },
      {
        "m": "Front Delts (stability)",
        "s": 20
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Drag Curl",
    "station": "Smith Machine",
    "muscle_group": "BICEPS",
    "pattern": "Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "8-12",
    "impact": [
      {
        "m": "Biceps",
        "s": 92
      },
      {
        "m": "Brachialis",
        "s": 60
      },
      {
        "m": "Forearms/Grip",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Inverted Row (underhand grip, biceps bias)",
    "station": "Smith Machine",
    "muscle_group": "BICEPS",
    "pattern": "Bodyweight Pull",
    "unilateral": false,
    "sets": 2,
    "reps": "8-12",
    "impact": [
      {
        "m": "Biceps",
        "s": 90
      },
      {
        "m": "Lats",
        "s": 65
      },
      {
        "m": "Mid Back",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Triceps Pushdown (V-bar)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Pushdown",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Anconeus",
        "s": 55
      },
      {
        "m": "Lats (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Triceps Pushdown (straight bar)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Pushdown",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Anconeus",
        "s": 55
      },
      {
        "m": "Forearms/Grip",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Rope Triceps Pushdown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Pushdown",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Anconeus",
        "s": 55
      },
      {
        "m": "Forearms/Grip",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Single-Arm Triceps Pushdown",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Pushdown",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Forearms/Grip",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Overhead Triceps Extension (rope)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Overhead Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Triceps (long head)",
        "s": 95
      },
      {
        "m": "Shoulder stabilizers",
        "s": 55
      },
      {
        "m": "Core (bracing)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Single-Arm Overhead Triceps Extension",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Overhead Extension",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Triceps (long head)",
        "s": 95
      },
      {
        "m": "Shoulder stabilizers",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Lying Cable Triceps Extension (skullcrusher)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "TRICEPS",
    "pattern": "Elbow Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Triceps (long head)",
        "s": 95
      },
      {
        "m": "Forearms/Grip",
        "s": 55
      },
      {
        "m": "Shoulder stabilizers",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Triceps Kickback",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "TRICEPS",
    "pattern": "Kickback",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Triceps",
        "s": 92
      },
      {
        "m": "Rear Delts (stability)",
        "s": 55
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Close-Grip Bench Press (triceps bias)",
    "station": "Smith Machine",
    "muscle_group": "TRICEPS",
    "pattern": "Press (triceps bias)",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Chest (sternal pec)",
        "s": 60
      },
      {
        "m": "Front Delts",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith JM Press",
    "station": "Smith Machine",
    "muscle_group": "TRICEPS",
    "pattern": "Press (triceps bias)",
    "unilateral": false,
    "sets": 2,
    "reps": "6-10",
    "impact": [
      {
        "m": "Triceps",
        "s": 95
      },
      {
        "m": "Chest",
        "s": 55
      },
      {
        "m": "Front Delts",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Wrist Curl (straight bar)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Wrist Flexion",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Wrist Flexors",
        "s": 95
      },
      {
        "m": "Grip",
        "s": 60
      },
      {
        "m": "Brachialis (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Reverse Wrist Curl (straight bar)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Wrist Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Wrist Extensors",
        "s": 95
      },
      {
        "m": "Grip",
        "s": 55
      },
      {
        "m": "Brachioradialis",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Wrist Curl",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Wrist Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Wrist Flexors",
        "s": 95
      },
      {
        "m": "Grip",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 20
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Single-Arm Reverse Wrist Curl",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Wrist Extension",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Wrist Extensors",
        "s": 95
      },
      {
        "m": "Grip",
        "s": 55
      },
      {
        "m": "Core (anti-rotation)",
        "s": 20
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Pronations (handle)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Pronation",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Pronators",
        "s": 92
      },
      {
        "m": "Grip",
        "s": 55
      },
      {
        "m": "Wrist Extensors (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Supinations (handle)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Supination",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/side",
    "impact": [
      {
        "m": "Supinators/Biceps synergy",
        "s": 90
      },
      {
        "m": "Biceps",
        "s": 55
      },
      {
        "m": "Grip",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Bar Static Hold (double overhand)",
    "station": "Smith Machine",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Isometric Hold",
    "unilateral": false,
    "sets": 2,
    "reps": "20-40s",
    "impact": [
      {
        "m": "Grip",
        "s": 95
      },
      {
        "m": "Forearm Flexors",
        "s": 70
      },
      {
        "m": "Upper Traps (support)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Bar Static Hold (mixed grip)",
    "station": "Smith Machine",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Isometric Hold",
    "unilateral": false,
    "sets": 2,
    "reps": "20-40s",
    "impact": [
      {
        "m": "Grip",
        "s": 95
      },
      {
        "m": "Forearm Flexors",
        "s": 70
      },
      {
        "m": "Biceps (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Cable Reverse Curl (forearm emphasis)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "FOREARMS_GRIP",
    "pattern": "Reverse Curl",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Brachioradialis",
        "s": 95
      },
      {
        "m": "Wrist Extensors",
        "s": 55
      },
      {
        "m": "Biceps",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Back Squat",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Squat",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Quads",
        "s": 95
      },
      {
        "m": "Glutes",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Front Squat (cross-arm)",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Squat",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Quads",
        "s": 96
      },
      {
        "m": "Upper Back (posture)",
        "s": 60
      },
      {
        "m": "Glutes",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Hack Squat (feet forward)",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Squat",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Quads",
        "s": 96
      },
      {
        "m": "Glutes",
        "s": 60
      },
      {
        "m": "Calves (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Split Squat",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Lunge/Split Squat",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Quads",
        "s": 93
      },
      {
        "m": "Glutes",
        "s": 70
      },
      {
        "m": "Adductors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Bulgarian Split Squat",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Lunge/Split Squat",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Quads",
        "s": 93
      },
      {
        "m": "Glutes",
        "s": 70
      },
      {
        "m": "Core (bracing)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Reverse Lunge",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Lunge",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Quads",
        "s": 92
      },
      {
        "m": "Glutes",
        "s": 72
      },
      {
        "m": "Adductors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Step-Up (bench/platform)",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Step-Up",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Quads",
        "s": 92
      },
      {
        "m": "Glutes",
        "s": 70
      },
      {
        "m": "Calves (stability)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Lying Leg Press (bench setup)",
    "station": "Smith Machine",
    "muscle_group": "QUADS",
    "pattern": "Leg Press",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Quads",
        "s": 95
      },
      {
        "m": "Glutes",
        "s": 65
      },
      {
        "m": "Hamstrings",
        "s": 35
      }
    ],
    "note": "Likely requires a dedicated leg-press plate/attachment. If you don't have it, remove this exercise."
  },
  {
    "name": "TYTAX T1 | Seated Leg Extension",
    "station": "Leg Extension Seat",
    "muscle_group": "QUADS",
    "pattern": "Knee Extension",
    "unilateral": false,
    "sets": 3,
    "reps": "10-20",
    "impact": [
      {
        "m": "Quads",
        "s": 96
      },
      {
        "m": "Hip Flexors (rectus femoris synergy)",
        "s": 50
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Seated Single-Leg Leg Extension",
    "station": "Leg Extension Seat",
    "muscle_group": "QUADS",
    "pattern": "Knee Extension",
    "unilateral": true,
    "sets": 2,
    "reps": "10-20/leg",
    "impact": [
      {
        "m": "Quads",
        "s": 96
      },
      {
        "m": "Hip Flexors (stability)",
        "s": 55
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Seated Leg Curl",
    "station": "Leg Curl Seat",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Knee Flexion",
    "unilateral": false,
    "sets": 3,
    "reps": "10-20",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 96
      },
      {
        "m": "Gastrocnemius",
        "s": 55
      },
      {
        "m": "Glutes (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Seated Single-Leg Leg Curl",
    "station": "Leg Curl Seat",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Knee Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "10-20/leg",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 96
      },
      {
        "m": "Gastrocnemius",
        "s": 55
      },
      {
        "m": "Glutes (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Romanian Deadlift (RDL)",
    "station": "Smith Machine",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Hinge/RDL",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 95
      },
      {
        "m": "Glutes",
        "s": 75
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Stiff-Leg Deadlift",
    "station": "Smith Machine",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Hinge/RDL",
    "unilateral": false,
    "sets": 3,
    "reps": "6-10",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 95
      },
      {
        "m": "Glutes",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Good Morning (light/strict)",
    "station": "Smith Machine",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Hinge",
    "unilateral": false,
    "sets": 2,
    "reps": "8-12",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 95
      },
      {
        "m": "Spinal Erectors",
        "s": 75
      },
      {
        "m": "Glutes",
        "s": 35
      }
    ],
    "note": "Advanced/technique-sensitive. If your lower back is the limiting factor, treat spinal erectors as the primary limiter and keep loads modest."
  },
  {
    "name": "TYTAX T1 | Smith Single-Leg RDL",
    "station": "Smith Machine",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Hinge/RDL",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 93
      },
      {
        "m": "Glutes",
        "s": 75
      },
      {
        "m": "Core (balance/bracing)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Cable Pull-Through",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Hinge",
    "unilateral": false,
    "sets": 3,
    "reps": "10-15",
    "impact": [
      {
        "m": "Glutes",
        "s": 92
      },
      {
        "m": "Hamstrings",
        "s": 70
      },
      {
        "m": "Core (bracing)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Standing Hamstring Curl (ankle strap)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Knee Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/leg",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 94
      },
      {
        "m": "Gastrocnemius",
        "s": 55
      },
      {
        "m": "Glutes (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Kneeling Hamstring Curl (ankle strap)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Knee Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/leg",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 95
      },
      {
        "m": "Glutes (stability)",
        "s": 55
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Seated Leg Curl (2s squeeze + slow eccentric)",
    "station": "Leg Curl Seat",
    "muscle_group": "HAMSTRINGS",
    "pattern": "Knee Flexion",
    "unilateral": false,
    "sets": 2,
    "reps": "8-12",
    "impact": [
      {
        "m": "Hamstrings",
        "s": 95
      },
      {
        "m": "Gastrocnemius",
        "s": 55
      },
      {
        "m": "Glutes (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Hip Thrust",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Hip Thrust",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Glutes",
        "s": 97
      },
      {
        "m": "Hamstrings",
        "s": 65
      },
      {
        "m": "Quads (stability)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Glute Bridge",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Glute Bridge",
    "unilateral": false,
    "sets": 3,
    "reps": "10-15",
    "impact": [
      {
        "m": "Glutes",
        "s": 95
      },
      {
        "m": "Hamstrings",
        "s": 60
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Single-Leg Hip Thrust",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Hip Thrust",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Glutes",
        "s": 95
      },
      {
        "m": "Hamstrings",
        "s": 60
      },
      {
        "m": "Core (pelvic control)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Sumo Squat (glute bias)",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Squat (glute bias)",
    "unilateral": false,
    "sets": 3,
    "reps": "8-12",
    "impact": [
      {
        "m": "Glutes",
        "s": 93
      },
      {
        "m": "Adductors",
        "s": 70
      },
      {
        "m": "Quads",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Reverse Lunge (long stride glute bias)",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Lunge (glute bias)",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Glutes",
        "s": 93
      },
      {
        "m": "Quads",
        "s": 65
      },
      {
        "m": "Adductors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Bulgarian Split Squat (forward lean glute bias)",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Split Squat (glute bias)",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Glutes",
        "s": 94
      },
      {
        "m": "Quads",
        "s": 60
      },
      {
        "m": "Core (bracing)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Cable Glute Kickback (ankle strap)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "GLUTES",
    "pattern": "Hip Extension Isolation",
    "unilateral": true,
    "sets": 2,
    "reps": "12-20/leg",
    "impact": [
      {
        "m": "Glutes",
        "s": 95
      },
      {
        "m": "Hamstrings",
        "s": 50
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Cable Pull-Through (glute squeeze)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "GLUTES",
    "pattern": "Hinge",
    "unilateral": false,
    "sets": 3,
    "reps": "10-15",
    "impact": [
      {
        "m": "Glutes",
        "s": 92
      },
      {
        "m": "Hamstrings",
        "s": 70
      },
      {
        "m": "Core (bracing)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Deadlift (hip-dominant glute focus)",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Deadlift/Hinge",
    "unilateral": false,
    "sets": 2,
    "reps": "5-8",
    "impact": [
      {
        "m": "Glutes",
        "s": 95
      },
      {
        "m": "Hamstrings",
        "s": 75
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Step-Up (high step glute bias)",
    "station": "Smith Machine",
    "muscle_group": "GLUTES",
    "pattern": "Step-Up",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12/leg",
    "impact": [
      {
        "m": "Glutes",
        "s": 92
      },
      {
        "m": "Quads",
        "s": 65
      },
      {
        "m": "Calves (stability)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Standing Calf Raise",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 3,
    "reps": "12-20",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 95
      },
      {
        "m": "Soleus",
        "s": 65
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Seated Calf Raise (bench setup)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 3,
    "reps": "12-25",
    "impact": [
      {
        "m": "Soleus",
        "s": 95
      },
      {
        "m": "Gastrocnemius",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Donkey Calf Raise (hip hinge support)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 3,
    "reps": "12-25",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 94
      },
      {
        "m": "Soleus",
        "s": 60
      },
      {
        "m": "Core (bracing)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Vertical Calf Press (leg press setup)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Press",
    "unilateral": false,
    "sets": 3,
    "reps": "12-25",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 95
      },
      {
        "m": "Soleus",
        "s": 65
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 30
      }
    ],
    "note": "Likely requires a dedicated leg-press plate/attachment. If you don't have it, remove this exercise."
  },
  {
    "name": "TYTAX T1 | Smith Single-Leg Standing Calf Raise",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": true,
    "sets": 2,
    "reps": "10-20/leg",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 94
      },
      {
        "m": "Soleus",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Standing Calf Raise (toes-in)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 93
      },
      {
        "m": "Soleus",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Standing Calf Raise (toes-out)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 2,
    "reps": "12-20",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 93
      },
      {
        "m": "Soleus",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Seated Calf Raise (slow eccentric 3s)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Soleus",
        "s": 94
      },
      {
        "m": "Gastrocnemius",
        "s": 55
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Standing Calf Raise (2s top hold)",
    "station": "Smith Machine",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 2,
    "reps": "8-12 (2s hold)",
    "impact": [
      {
        "m": "Gastrocnemius",
        "s": 94
      },
      {
        "m": "Soleus",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Calf Raise (belt/strap)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CALVES",
    "pattern": "Calf Raise",
    "unilateral": false,
    "sets": 2,
    "reps": "12-25",
    "impact": [
      {
        "m": "Soleus",
        "s": 92
      },
      {
        "m": "Gastrocnemius",
        "s": 60
      },
      {
        "m": "Foot/Ankle Stabilizers",
        "s": 30
      }
    ],
    "note": "Optional if you add a belt/strap"
  },
  {
    "name": "TYTAX T1 | Upper Pulley Kneeling Cable Crunch",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CORE",
    "pattern": "Trunk Flexion",
    "unilateral": false,
    "sets": 2,
    "reps": "10-20",
    "impact": [
      {
        "m": "Abs (rectus abdominis)",
        "s": 95
      },
      {
        "m": "Hip Flexors",
        "s": 50
      },
      {
        "m": "Obliques",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Standing Cable Crunch",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CORE",
    "pattern": "Trunk Flexion",
    "unilateral": false,
    "sets": 2,
    "reps": "10-20",
    "impact": [
      {
        "m": "Abs (rectus abdominis)",
        "s": 93
      },
      {
        "m": "Obliques",
        "s": 55
      },
      {
        "m": "Hip Flexors",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Pallof Press (anti-rotation hold)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CORE",
    "pattern": "Anti-Rotation",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12 (2s hold)/side",
    "impact": [
      {
        "m": "Obliques (anti-rotation)",
        "s": 95
      },
      {
        "m": "Abs (bracing)",
        "s": 70
      },
      {
        "m": "Glute Med/Min (pelvic control)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Pallof Press (anti-rotation hold)",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CORE",
    "pattern": "Anti-Rotation",
    "unilateral": true,
    "sets": 2,
    "reps": "8-12 (2s hold)/side",
    "impact": [
      {
        "m": "Obliques (anti-rotation)",
        "s": 95
      },
      {
        "m": "Abs (bracing)",
        "s": 70
      },
      {
        "m": "Glute Med/Min (pelvic control)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley High-to-Low Woodchop",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CORE",
    "pattern": "Rotation/Chop",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Obliques",
        "s": 95
      },
      {
        "m": "Abs",
        "s": 70
      },
      {
        "m": "Glutes/Hip rotators (stability)",
        "s": 30
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Low-to-High Woodchop",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CORE",
    "pattern": "Rotation/Chop",
    "unilateral": true,
    "sets": 2,
    "reps": "10-15/side",
    "impact": [
      {
        "m": "Obliques",
        "s": 95
      },
      {
        "m": "Abs",
        "s": 65
      },
      {
        "m": "Side Delts (stability)",
        "s": 25
      }
    ]
  },
  {
    "name": "TYTAX T1 | Lower Pulley Cable Side Bend",
    "station": "Back Lower Pulley (Station with lower pulley)",
    "muscle_group": "CORE",
    "pattern": "Lateral Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "10-20/side",
    "impact": [
      {
        "m": "Obliques",
        "s": 95
      },
      {
        "m": "Quadratus Lumborum (QL)",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Side Bend",
    "station": "Smith Machine",
    "muscle_group": "CORE",
    "pattern": "Lateral Flexion",
    "unilateral": true,
    "sets": 2,
    "reps": "10-20/side",
    "impact": [
      {
        "m": "Obliques",
        "s": 95
      },
      {
        "m": "Quadratus Lumborum (QL)",
        "s": 70
      },
      {
        "m": "Spinal Erectors (stability)",
        "s": 35
      }
    ]
  },
  {
    "name": "TYTAX T1 | Smith Romanian Deadlift Iso-Hold (mid-shin, light)",
    "station": "Smith Machine",
    "muscle_group": "CORE",
    "pattern": "Isometric Hinge/Brace",
    "unilateral": false,
    "sets": 2,
    "reps": "15-30s hold",
    "impact": [
      {
        "m": "Spinal Erectors (isometric)",
        "s": 92
      },
      {
        "m": "Hamstrings",
        "s": 65
      },
      {
        "m": "Glutes",
        "s": 40
      }
    ]
  },
  {
    "name": "TYTAX T1 | Upper Pulley Anti-Extension Pressdown (straight arms)",
    "station": "Back Upper Pulley (either back station)",
    "muscle_group": "CORE",
    "pattern": "Anti-Extension",
    "unilateral": false,
    "sets": 2,
    "reps": "10-15",
    "impact": [
      {
        "m": "Abs (anti-extension)",
        "s": 92
      },
      {
        "m": "Lats (stability)",
        "s": 55
      },
      {
        "m": "Serratus/Scapular control",
        "s": 30
      }
    ],
    "note": "Think: 'cable rollout' but standing"
  }
],
                  "INITIAL_PLAN": {
                        "Upper A": [
                            "TYTAX T1 | Smith Flat Bench Press",
                            "TYTAX T1 | Upper Pulley Wide-Grip Lat Pulldown",
                            "TYTAX T1 | Lower Pulley Seated Cable Row (bench)",
                            "TYTAX T1 | Smith Seated Shoulder Press",
                            "TYTAX T1 | Lower Pulley Seated Cable Curl (bench)",
                            "TYTAX T1 | Upper Pulley Triceps Pushdown (straight bar)"
                        ],
                        "Lower A": [
                            "TYTAX T1 | Smith Back Squat",
                            "TYTAX T1 | Smith Romanian Deadlift (RDL)",
                            "TYTAX T1 | Smith Hip Thrust",
                            "TYTAX T1 | Smith Standing Calf Raise",
                            "TYTAX T1 | Upper Pulley Kneeling Cable Crunch"
                        ],
                        "Upper B": [
                            "TYTAX T1 | Smith Incline Bench Press",
                            "TYTAX T1 | Upper Pulley Close-Grip Lat Pulldown",
                            "TYTAX T1 | Lower Pulley Wide-Grip Seated Cable Row",
                            "TYTAX T1 | Smith Standing Overhead Press",
                            "TYTAX T1 | Upper Pulley High Cable Curl (D-handles)",
                            "TYTAX T1 | Upper Pulley Rope Triceps Pushdown"
                        ],
                        "Lower B": [
                            "TYTAX T1 | Smith Lying Leg Press (bench setup)",
                            "TYTAX T1 | Smith Stiff-Leg Deadlift",
                            "TYTAX T1 | Smith Glute Bridge",
                            "TYTAX T1 | Smith Seated Calf Raise (bench setup)",
                            "TYTAX T1 | Upper Pulley High-to-Low Woodchop"
                        ],
                        "Upper C": [
                            "TYTAX T1 | Smith Decline Bench Press",
                            "TYTAX T1 | Upper Pulley Underhand Lat Pulldown",
                            "TYTAX T1 | Lower Pulley Single-Arm Seated Cable Row",
                            "TYTAX T1 | Lower Pulley Single-Arm Lateral Raise",
                            "TYTAX T1 | Lower Pulley Standing Cable Curl (straight bar)",
                            "TYTAX T1 | Upper Pulley Single-Arm Triceps Pushdown"
                        ],
                        "Lower C": [
                            "TYTAX T1 | Smith Bulgarian Split Squat",
                            "TYTAX T1 | Smith Single-Leg RDL",
                            "TYTAX T1 | Lower Pulley Cable Glute Kickback (ankle strap)",
                            "TYTAX T1 | Smith Single-Leg Standing Calf Raise",
                            "TYTAX T1 | Upper Pulley Standing Cable Crunch"
                        ],
                        "Rest Day": []
                    },
                  "INITIAL_ORDER": [
                        "Upper A", "Lower A", "Upper B", "Lower B", "Upper C", "Lower C", "Rest Day"
                    ]
                }
            } 
        ]; 
 
        const ProgressGraph = ({ data, color = "#818cf8", label = "Value" }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data || data.length < 2) return;
                
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, color + '40'); 
                gradient.addColorStop(1, color + '00'); 

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: label,
                            data: data.map(d => d.value),
                            borderColor: color,
                            backgroundColor: gradient,
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: color,
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#f8fafc',
                                bodyColor: '#94a3b8',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                padding: 12,
                                titleFont: { family: "'Inter', sans-serif", size: 10, weight: '900' },
                                bodyFont: { family: "'Inter', sans-serif", size: 12, weight: 'bold' },
                                displayColors: false,
                                callbacks: { label: (c) => `${c.parsed.y}` }
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: {
                                display: true,
                                position: 'right',
                                grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                                ticks: { color: '#475569', font: { size: 9, family: "'Inter', sans-serif", weight: '700' }, maxTicksLimit: 5 },
                                border: { display: false }
                            }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false },
                        animation: { duration: 1000, easing: 'easeOutQuart' }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, color, label]);

            if (!data || data.length < 2) return (
                <div className="h-48 flex flex-col items-center justify-center text-slate-700 space-y-2 border border-white/5 rounded-3xl bg-slate-900/20">
                    <Icon name="trends" className="w-6 h-6 opacity-20" />
                    <span className="text-[8px] uppercase font-black italic tracking-widest opacity-40">Gathering Data</span>
                </div>
            );

            return (
                <div className="w-full h-56 bg-slate-900/40 p-4 rounded-[2rem] border border-white/5 relative">
                    <canvas ref={canvasRef} className="absolute top-0 left-0 w-full h-full" />
                    <div className="absolute top-4 left-6 pointer-events-none">
                         <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Latest</p>
                         <p className="text-2xl font-black text-white italic">{data[data.length-1].value}</p>
                    </div>
                </div>
            );
        };

        const OneRepMaxCalculator = ({ onClose }) => {
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            
            const e1rm = calculateE1RM(weight, reps);
            
            return (
                <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6" onClick={onClose}>
                    <div className="bg-slate-900 border border-white/10 rounded-[2rem] p-8 w-full max-w-sm space-y-6" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-black text-white italic uppercase tracking-tighter">1RM<br/><span className="text-indigo-500">Projector</span></h3>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-xl text-slate-400"><Icon name="x" /></button>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <label className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Weight (KG)</label>
                                <input type="number" value={weight} onChange={e => setWeight(e.target.value)} className="w-full p-4 bg-black rounded-2xl font-black text-white border-none focus:ring-2 focus:ring-indigo-500" placeholder="0" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Reps</label>
                                <input type="number" value={reps} onChange={e => setReps(e.target.value)} className="w-full p-4 bg-black rounded-2xl font-black text-white border-none focus:ring-2 focus:ring-indigo-500" placeholder="0" />
                            </div>
                        </div>
                        
                        <div className="bg-slate-800/50 p-6 rounded-[2rem] space-y-4">
                            <div className="flex justify-between items-center">
                                <span className="text-xs font-black text-white uppercase tracking-widest">Est. 1RM</span>
                                <span className="text-3xl font-black text-indigo-400 italic">{e1rm}<span className="text-sm text-slate-500 not-italic ml-1">kg</span></span>
                            </div>
                            <div className="h-px bg-white/5" />
                            <div className="grid grid-cols-3 gap-2 text-center">
                                {[3, 5, 8, 10, 12, 15].map(r => (
                                    <div key={r} className="p-2 bg-slate-900 rounded-xl">
                                        <div className="text-[8px] font-bold text-slate-500 uppercase">{r}RM</div>
                                        <div className="text-xs font-black text-white mt-1">{Math.round(e1rm * (37 - r) / 36)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PRModal = ({ prs, onClose }) => {
            return (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in" onClick={onClose}>
                    <div className="w-full max-w-sm space-y-8 text-center relative">
                        {/* Confetti / Glow Effect */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-amber-500/20 blur-[100px] rounded-full animate-pulse" />
                        
                        <div className="relative z-10 space-y-2">
                            <Icon name="bolt" className="w-16 h-16 text-amber-400 mx-auto animate-bounce" />
                            <h2 className="text-4xl font-black italic uppercase text-white tracking-tighter leading-none">New<br/><span className="text-amber-400">Record</span></h2>
                        </div>

                        <div className="space-y-3 relative z-10">
                            {prs.map((pr, i) => (
                                <div key={i} className="bg-slate-900/80 border border-amber-500/30 p-4 rounded-2xl backdrop-blur-xl">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{pr.exercise}</p>
                                    <p className="text-2xl font-black text-white italic">{pr.kg}kg <span className="text-sm text-amber-400 not-italic">({pr.diff > 0 ? '+' : ''}{pr.diff}kg)</span></p>
                                </div>
                            ))}
                        </div>

                        <button onClick={onClose} className="w-full py-4 bg-amber-500 text-black rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-xl hover:scale-105 transition-transform relative z-10">Claim Victory</button>
                    </div>
                </div>
            );
        };

        const PlateCalculator = ({ targetKg, onClose }) => {
            const [barWeight, setBarWeight] = useState(() => parseInt(localStorage.getItem('tytax_bar_weight') || '20'));
            useEffect(() => { localStorage.setItem('tytax_bar_weight', barWeight); }, [barWeight]);
            const plates = [25, 20, 15, 10, 5, 2.5, 1.25];
            
            const calculate = () => {
                let weight = (targetKg - barWeight) / 2;
                if (weight <= 0) return [];
                const needed = [];
                plates.forEach(p => {
                    while (weight >= p) {
                        needed.push(p);
                        weight -= p;
                    }
                });
                return needed;
            };
            
            const result = calculate();
            
            return (
                <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6" onClick={onClose}>
                    <div className="bg-slate-900 border border-white/10 rounded-[2rem] p-8 w-full max-w-sm space-y-6" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-black text-white italic uppercase tracking-tighter">Plate<br/><span className="text-indigo-500">Loader</span></h3>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-xl text-slate-400"><Icon name="x" /></button>
                        </div>
                        
                        <div className="flex justify-between items-center bg-slate-800/50 p-4 rounded-2xl">
                            <span className="text-xs font-black text-slate-400 uppercase tracking-widest">Target</span>
                            <span className="text-2xl font-black text-white">{targetKg} <span className="text-xs text-slate-500">KG</span></span>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="flex justify-between text-[10px] font-black uppercase tracking-widest text-slate-500">
                                <span>Per Side</span>
                                <span>{Math.max(0, (targetKg - barWeight) / 2)}kg</span>
                            </div>
                            <div className="flex flex-wrap gap-2 justify-center">
                                {result.length > 0 ? result.map((p, i) => (
                                    <div key={i} className="w-16 h-16 rounded-full border-4 border-slate-700 bg-slate-800 flex items-center justify-center shadow-lg relative">
                                        <span className="text-sm font-black text-white">{p}</span>
                                        <div className="absolute inset-0 rounded-full shadow-[inset_0_2px_4px_rgba(255,255,255,0.1)]" />
                                    </div>
                                )) : <p className="text-xs text-slate-600 italic">Bar Only / Invalid</p>}
                            </div>
                        </div>

                        <div className="space-y-2">
                             <label className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Bar Weight</label>
                             <div className="flex gap-2">
                                {[20, 15, 10].map(w => (
                                    <button key={w} onClick={() => setBarWeight(w)} className={`flex-1 py-3 rounded-xl text-[10px] font-black transition-all ${barWeight === w ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-slate-500'}`}>{w}kg</button>
                                ))}
                             </div>
                        </div>
                    </div>
                </div>
            );
        };
 
        const BuilderWizard = ({ onComplete, onCancel }) => {
            const [step, setStep] = useState(1);
            const [config, setConfig] = useState({ days: 3, split: 'FB', session: null });

            // Step 1: Frequency
            if (step === 1) {
                return (
                    <div className="absolute inset-0 z-50 glass flex items-center justify-center p-6 animate-fade-in">
                        <div className="max-w-sm w-full space-y-8">
                            <div className="text-center space-y-2">
                                <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">Training<br/><span className="text-indigo-500">Frequency</span></h2>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">How many days per week?</p>
                            </div>
                            <div className="grid grid-cols-3 gap-3">
                                {[2,3,4,5,6].map(d => (
                                    <button key={d} onClick={() => { setConfig({...config, days: d}); setStep(2); }} className="p-6 bg-slate-900 rounded-2xl border border-white/5 hover:border-indigo-500 hover:text-indigo-400 transition-all group">
                                        <span className="text-2xl font-black italic text-white group-hover:text-indigo-400">{d}</span>
                                        <span className="block text-[8px] font-bold uppercase text-slate-600 group-hover:text-indigo-500">Days</span>
                                    </button>
                                ))}
                            </div>
                            <button onClick={onCancel} className="w-full py-4 text-[10px] font-black uppercase tracking-widest text-slate-600 hover:text-slate-400">Cancel</button>
                        </div>
                    </div>
                );
            }

            // Step 2: Split Selection
            if (step === 2) {
                // Logic: 5+ days = PPL or UL; 4 days = UL or PPL; <4 days = FB or UL
                const splits = config.days >= 5 ? ['PPL', 'UL'] : config.days === 4 ? ['UL', 'PPL'] : ['FB', 'UL'];
                const splitNames = { 'PPL': 'Push / Pull / Legs', 'UL': 'Upper / Lower', 'FB': 'Full Body' };
                
                return (
                    <div className="absolute inset-0 z-50 glass flex items-center justify-center p-6">
                        <div className="max-w-sm w-full space-y-8">
                            <div className="text-center space-y-2">
                                <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">Split<br/><span className="text-indigo-500">Structure</span></h2>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Recommended for {config.days} Days</p>
                            </div>
                            <div className="space-y-3">
                                {splits.map(s => (
                                    <button key={s} onClick={() => onComplete({...config, split: s})} className="w-full p-5 bg-slate-900 rounded-2xl border border-white/5 text-left flex justify-between items-center group hover:bg-indigo-900/20 transition-all">
                                        <span className="text-sm font-black italic uppercase text-white group-hover:text-indigo-300">{splitNames[s]}</span>
                                        <Icon name="bolt" className="text-slate-700 group-hover:text-indigo-500" />
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setStep(1)} className="w-full py-4 text-[10px] font-black uppercase tracking-widest text-slate-600 hover:text-white">Back</button>
                        </div>
                    </div>
                );
            }

            // Step 3: Session Focus
            // Logic: Determine valid session types based on the chosen split
            const sessions = config.split === 'PPL' ? ['Push', 'Pull', 'Legs'] : config.split === 'UL' ? ['Upper', 'Lower'] : ['Full Body'];
            
            return (
                <div className="absolute inset-0 z-50 glass flex items-center justify-center p-6">
                    <div className="max-w-sm w-full space-y-8">
                        <div className="text-center space-y-2">
                            <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">Design<br/><span className="text-indigo-500">Target</span></h2>
                            <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">What are we building today?</p>
                        </div>
                        <div className="space-y-3">
                            {sessions.map(s => (
                                <button key={s} onClick={() => onComplete({...config, session: s})} className="w-full p-6 accent-gradient rounded-[2rem] text-center shadow-xl hover:scale-105 transition-transform group">
                                    <span className="text-lg font-black italic uppercase text-white tracking-widest group-hover:text-white">{s} A</span>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setStep(2)} className="w-full py-4 text-[10px] font-black uppercase tracking-widest text-slate-600 hover:text-white">Back</button>
                    </div>
                </div>
            );
        };

        const ProgramManager = ({ config, programDraft, onEditSlot, onPublish, onCancel }) => {
            // Calculate overall completion
            const filledSlots = programDraft.filter(d => d.exercises.length > 0).length;
            const isComplete = filledSlots === programDraft.length;

            return (
                <div className="tab-content space-y-6 pb-32">
                    {/* Header */}
                    <div className="sticky top-0 bg-[#020617]/95 backdrop-blur-xl z-30 p-4 -mx-4 border-b border-white/5 space-y-4">
                        <div className="flex justify-between items-end">
                            <div>
                                 <h2 className="text-3xl font-black tracking-tighter italic uppercase leading-none">Program<br/><span className="text-indigo-500">Manager</span></h2>
                                 <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-2">{config.days}-Day {config.split} Split</p>
                            </div>
                            <button 
                                onClick={onPublish} 
                                disabled={!isComplete}
                                className="px-6 py-3 bg-emerald-500 text-black rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg disabled:opacity-20 disabled:cursor-not-allowed flex items-center gap-2 transition-all"
                            >
                                <Icon name="check" className="w-4 h-4" /> Publish
                            </button>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="h-1 bg-slate-800 rounded-full overflow-hidden">
                            <div className="h-full bg-emerald-500 transition-all duration-500" style={{width: `${(filledSlots / programDraft.length) * 100}%`}} />
                        </div>
                    </div>

                    {/* Session Slots */}
                    <div className="grid grid-cols-1 gap-4">
                        {programDraft.map((day, idx) => (
                            <div key={idx} onClick={() => onEditSlot(idx)} className={`p-6 rounded-[2.5rem] border transition-all cursor-pointer relative overflow-hidden group ${day.exercises.length > 0 ? 'bg-indigo-900/10 border-indigo-500/50' : 'bg-slate-900 border-white/5 hover:border-indigo-500/30'}`}>
                                <div className="flex justify-between items-center relative z-10">
                                    <div className="space-y-1">
                                        <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Day {idx + 1}</span>
                                        <h3 className={`text-xl font-black italic uppercase tracking-tighter ${day.exercises.length > 0 ? 'text-white' : 'text-slate-600'}`}>{day.name}</h3>
                                        {day.exercises.length > 0 ? (
                                            <p className="text-[10px] text-indigo-400 font-bold">{day.exercises.length} Exercises â€¢ {getProjectedImpact(day.exercises)[0]?.muscle || 'Mixed'} Focus</p>
                                        ) : (
                                            <p className="text-[10px] text-slate-600 italic">Empty Slot - Tap to Design</p>
                                        )}
                                    </div>
                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${day.exercises.length > 0 ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-800 text-slate-600 group-hover:text-indigo-400'}`}>
                                        <Icon name={day.exercises.length > 0 ? 'check' : 'tool'} className="w-5 h-5" />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button onClick={onCancel} className="w-full py-6 text-[10px] font-black uppercase tracking-widest text-slate-600 hover:text-red-500 transition-colors bg-slate-900/50 rounded-[2rem]">Discard Program Draft</button>
                </div>
            );
        };

        const BuilderTab = ({ metaLibrary, userInventory, onSave, onCancel }) => {
            // STATE: Global Program
            const [wizardConfig, setWizardConfig] = useState(null);
            const [programDraft, setProgramDraft] = useState([]); 
            const [activeSlot, setActiveSlot] = useState(null); // Index of day being edited
            const [view, setView] = useState('WIZARD'); // WIZARD -> MANAGER -> EDITOR

            // STATE: Single Session Editor
            const [filter, setFilter] = useState('ALL');
            const [search, setSearch] = useState('');
            const [draft, setDraft] = useState([]); // Exercises for current slot
            const [useInventoryFilter, setUseInventoryFilter] = useState(false);
            const [useSmartFilter, setUseSmartFilter] = useState(true);

            // 1. WIZARD COMPLETION -> GENERATE SLOTS
            const handleWizardComplete = (config) => {
                setWizardConfig(config);
                
                // Generate Empty Slots based on Split Type
                const slots = Array.from({ length: config.days }).map((_, i) => {
                    let name = `Day ${i+1}`;
                    // Auto-naming logic based on Split
                    if (config.split === 'PPL') {
                        const types = ['Push', 'Pull', 'Legs'];
                        name = `${types[i % 3]} ${String.fromCharCode(65 + Math.floor(i/3))}`;
                    } else if (config.split === 'UL') {
                        const types = ['Upper', 'Lower'];
                        name = `${types[i % 2]} ${String.fromCharCode(65 + Math.floor(i/2))}`;
                    } else {
                        name = `Full Body ${String.fromCharCode(65 + i)}`;
                    }
                    return { name, exercises: [] };
                });
                
                setProgramDraft(slots);
                setView('MANAGER');
            };

            // 2. OPEN SLOT -> LOAD EDITOR
            const openSlot = (idx) => {
                setActiveSlot(idx);
                setDraft(programDraft[idx].exercises); // Load existing exercises if any
                setFilter('ALL'); // Reset filters
                setView('EDITOR');
            };

            // 3. SAVE SLOT -> RETURN TO MANAGER
            const saveCurrentSlot = () => {
                const updated = structuredClone(programDraft);
                updated[activeSlot].exercises = draft;
                setProgramDraft(updated);
                setView('MANAGER');
            };

            // 4. PUBLISH -> SAVE TO APP PRESETS
            const publishProtocol = () => {
                const name = prompt("Name your Protocol:", `${wizardConfig.days}-Day ${wizardConfig.split} Elite`);
                if (!name) return;

                const newProtocol = {
                    id: `custom_${Date.now()}`,
                    name: name,
                    description: `Custom ${wizardConfig.days}-Day ${wizardConfig.split} program created in Architect.`,
                    data: {
                        // Map the draft slots to the protocol format
                        INITIAL_PLAN: programDraft.reduce((acc, day) => {
                            acc[day.name] = day.exercises.map(e => e.name);
                            return acc;
                        }, { "Rest Day": [] }),
                        INITIAL_ORDER: [...programDraft.map(d => d.name), "Rest Day"]
                    }
                };
                
                onSave(newProtocol);
            };

            // Get unique muscle groups for filter chips
            const categories = ['ALL', 'BACK', ...new Set(metaLibrary.map(ex => {
                if (ex.muscle_group) return ex.muscle_group;
                const imp = getImpact(ex);
                // Handle Chest mapping specifically if needed, otherwise uppercased name
                let m = imp.length > 0 ? imp[0].muscle : 'OTHER';
                return m.toUpperCase();
            }))];

            const projectedImpact = useMemo(() => getProjectedImpact(draft), [draft]);

            // CALCULATE RATIOS
            const { ratio, isImbalanced } = useMemo(() => {
                let push = 0, pull = 0;
                draft.forEach(ex => {
                    const p = (ex.pattern || "").toLowerCase();
                    if (p.includes("press") || p.includes("squat") || p.includes("extension") || p.includes("push")) push++;
                    if (p.includes("pull") || p.includes("row") || p.includes("curl") || p.includes("deadlift")) pull++;
                });
                
                // Avoid division by zero
                const ratioVal = pull === 0 ? push : push / pull;
                return {
                    ratio: { push, pull },
                    isImbalanced: ratioVal > 2.0 // Warning if Push is 2x Pull
                };
            }, [draft]);

            const optimizeStationFlow = () => {
                const optimized = [...draft].sort((a, b) => {
                    if (a.station === b.station) return 0;
                    return a.station > b.station ? 1 : -1;
                });
                setDraft(optimized);
            };

            // SMART FILTER LOGIC
            const filteredExercises = metaLibrary.filter(ex => {
                // 1. SMART CONTEXT FILTER
                const currentSlot = programDraft[activeSlot];
                const isSmartActive = useSmartFilter && filter === 'ALL' && search === '';
                
                if (currentSlot && isSmartActive) {
                    const sessionName = currentSlot.name.toLowerCase();
                    const isUpper = sessionName.includes('upper') || sessionName.includes('push'); // Removed 'pull' to allow deadlifts
                    const isPull = sessionName.includes('pull');
                    const isLower = sessionName.includes('lower') || sessionName.includes('legs');
                    
                    const imp = getImpact(ex);
                    const hits = (mList) => imp.some(i => mList.some(m => i.muscle.toLowerCase().includes(m.toLowerCase()) && i.level === 'Primary'));
                    const isCore = hits(['Abs', 'Obliques', 'Core', 'Serratus']);

                    if (!isCore) {
                        if (isUpper) {
                            // Strict Upper: No Legs
                            if (hits(['Quad', 'Hamstring', 'Glute', 'Calf', 'Calves'])) return false;
                        }
                        if (isPull) {
                            // Pull: Allow Back/Biceps/Rear Delt + Hamstrings/Glutes (Deadlifts). Exclude Quads/Push muscles.
                            if (hits(['Quad', 'Chest', 'Tricep', 'Front Delt', 'Calf'])) return false;
                        }
                        if (isLower) {
                            // Lower: No Upper Push/Pull (except maybe back for stability, but generally exclude)
                            if (hits(['Chest', 'Back', 'Lat', 'Trap', 'Rhomboid', 'Delt', 'Shoulder', 'Bicep', 'Tricep', 'Forearm', 'Grip', 'Brach'])) return false;
                        }
                    }
                }

                // 2. Inventory Filter
                if (useInventoryFilter) {
                    const att = getAttachment(ex.name, PRESETS);
                    if (att && !userInventory.includes(att.name) && att.priority !== 'Owned') return false;
                }

                // 3. Category & Search Filters
                const primaryMuscle = ex.muscle_group || (() => {
                    const i = getImpact(ex);
                    return i.length > 0 ? i[0].muscle.toUpperCase() : 'OTHER';
                })();
                
                let matchesCat = filter === 'ALL' || primaryMuscle === filter;
                if (filter === 'BACK' && (primaryMuscle === 'BACK_VERTICAL' || primaryMuscle === 'BACK_HORIZONTAL')) {
                    matchesCat = true;
                }
                const matchesSearch = ex.name.toLowerCase().includes(search.toLowerCase()) || 
                                      (ex.pattern && ex.pattern.toLowerCase().includes(search.toLowerCase()));
                return matchesCat && matchesSearch;
            });

            const toggleExercise = (ex) => {
                if (draft.find(e => e.name === ex.name)) {
                    setDraft(draft.filter(e => e.name !== ex.name));
                } else {
                    setDraft([...draft, ex]);
                }
            };

            // --- RENDER LOGIC ---

            // VIEW 1: WIZARD
            if (view === 'WIZARD') return <BuilderWizard onComplete={handleWizardComplete} onCancel={onCancel} />;

            // VIEW 2: MANAGER (HUB)
            if (view === 'MANAGER') return <ProgramManager config={wizardConfig} programDraft={programDraft} onEditSlot={openSlot} onPublish={publishProtocol} onCancel={onCancel} />;

            // VIEW 3: EDITOR (EXISTING BUILDER UI)
            if (view === 'EDITOR') {
                return (
                    <div className="tab-content space-y-6 pb-32">
                        {/* EDITOR HEADER */}
                        <div className="space-y-4 sticky top-0 bg-[#020617]/95 backdrop-blur-xl z-30 p-2 -mx-2">
                            <div className="flex justify-between items-end px-2">
                                <div>
                                     <h2 className="text-xl font-black italic uppercase text-white">{programDraft[activeSlot].name}</h2>
                                     <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Editing Session</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={optimizeStationFlow} className="px-4 py-2 bg-indigo-900/30 rounded-xl border border-indigo-500/30 flex items-center gap-2 hover:bg-indigo-900/50 transition-colors"><Icon name="bolt" className="w-3 h-3 text-indigo-400" /><span className="text-[8px] font-black uppercase tracking-widest text-indigo-400">Sort</span></button>
                                    <button onClick={() => setView('MANAGER')} className="px-4 py-2 bg-slate-800 rounded-xl border border-white/5 flex items-center gap-2 hover:bg-slate-700 transition-colors">
                                        <Icon name="x" className="w-3 h-3 text-slate-400" />
                                        <span className="text-[8px] font-black uppercase tracking-widest text-slate-400">Back</span>
                                    </button>
                                </div>
                            </div>
                            
                            {/* SEARCH & FILTER */}
                            <div className="flex gap-2">
                                <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search..." className="w-full p-4 bg-slate-900 rounded-2xl font-bold text-xs text-white border-none focus:ring-2 focus:ring-indigo-500" />
                                <button onClick={() => setUseInventoryFilter(!useInventoryFilter)} className={`px-4 rounded-2xl transition-colors ${useInventoryFilter ? 'bg-indigo-600 text-white' : 'bg-slate-900 text-slate-500 border border-white/5'}`}><Icon name="filter" /></button>
                            </div>

                            {/* FILTER CHIPS */}
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                {categories.map(cat => {
                                    // Smart Filter: Hide irrelevant buttons
                                    const currentSlot = programDraft[activeSlot];
                                    const isSmartActive = useSmartFilter && filter === 'ALL' && search === '';
                                    
                                    if (currentSlot && isSmartActive) {
                                        const sessionName = currentSlot.name.toLowerCase();
                                        const isUpper = sessionName.includes('upper') || sessionName.includes('push') || sessionName.includes('pull');
                                        const isLower = sessionName.includes('lower') || sessionName.includes('legs');

                                        if (isUpper && (cat === 'QUADS' || cat === 'HAMSTRINGS' || cat === 'GLUTES' || cat === 'CALVES')) return null;
                                        if (isLower && (cat === 'CHEST' || cat === 'BACK' || cat === 'SHOULDERS' || cat === 'BICEPS' || cat === 'TRICEPS' || cat === 'FOREARMS_GRIP')) return null;
                                    }

                                    return (
                                        <button 
                                            key={cat} 
                                            onClick={() => setFilter(cat)}
                                            className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest whitespace-nowrap transition-all ${filter === cat ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-900 text-slate-500 border border-white/5'}`}
                                        >
                                            {cat.replace('_', ' ')}
                                        </button>
                                    );
                                })}
                            </div>
                            
                        </div>

                        {/* EXERCISE GRID */}
                        {filteredExercises.length > 0 ? (
                            <div className="grid grid-cols-1 gap-4 pb-32"> {/* Added padding-bottom for the Dock */}
                                {filteredExercises.map(ex => {
                                    const isSelected = draft.some(e => e.name === ex.name);
                                    
                                    return (
                                        <div key={ex.name} onClick={() => toggleExercise(ex)} className={`p-6 rounded-[2.5rem] border transition-all duration-300 relative overflow-hidden group cursor-pointer ${isSelected ? 'bg-indigo-900/20 border-indigo-500/50' : 'glass border-white/5'}`}>
                                            {isSelected && <div className="absolute top-4 right-4 text-indigo-400"><Icon name="check" /></div>}
                                            
                                            <div className="space-y-3">
                                                <div className="flex flex-wrap gap-2">
                                                    <span className="px-2 py-1 bg-slate-800 rounded-lg text-[8px] font-black text-slate-400 uppercase tracking-wider">{ex.station || 'Free Weight'}</span>
                                                    {ex.unilateral && <span className="px-2 py-1 bg-purple-900/30 text-purple-400 rounded-lg text-[8px] font-black uppercase tracking-wider border border-purple-500/20">Unilateral</span>}
                                                </div>
                                                
                                                <h4 className={`font-black text-lg italic leading-tight ${isSelected ? 'text-indigo-200' : 'text-white'}`}>{cleanName(ex.name)}</h4>
                                                
                                                <div className="flex items-center justify-between">
                                                    <p className="text-[9px] font-bold text-slate-500 uppercase">{ex.pattern || 'Isolation'}</p>
                                                    {/* Project the primary muscle impact */}
                                                    <div className="flex items-center gap-1">
                                                        <div className="w-2 h-2 rounded-full bg-indigo-500" />
                                                        <span className="text-[9px] font-bold text-slate-400 uppercase">{normalizeMuscleName(ex.muscle_group || 'General')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="py-20 text-center space-y-6">
                                <div className="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto border border-white/5">
                                    <Icon name="library" className="w-8 h-8 text-slate-600" />
                                </div>
                                <div className="space-y-2">
                                    <p className="text-sm font-black text-white uppercase tracking-widest">No Matches</p>
                                    <p className="text-[10px] text-slate-500 max-w-[200px] mx-auto">Your filter "{normalizeMuscleName(filter)}" has no exercises in the current library.</p>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <button 
                                        onClick={() => setFilter('ALL')} 
                                        className="px-8 py-4 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] shadow-lg hover:scale-105 transition-transform"
                                    >
                                        Show All Exercises
                                    </button>
                                    <button 
                                        onClick={() => { setFilter('ALL'); setSearch(''); setUseInventoryFilter(false); }} 
                                        className="px-8 py-4 bg-slate-900 text-slate-500 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] border border-white/5 hover:text-white transition-colors"
                                    >
                                        Clear All Filters
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* LIVE IMPACT DOCK (Replaces Floating Button) */}
                        <div className="fixed bottom-0 left-0 right-0 glass border-t border-white/10 px-6 py-4 pb-8 z-[60] shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transition-transform duration-300">
                            <div className="max-w-md mx-auto space-y-3">
                                {/* Header Row */}
                                <div className="flex justify-between items-center">
                                     <div className="flex items-center gap-2">
                                        <Icon name="trends" className="w-3 h-3 text-indigo-400" />
                                        <span className="text-[10px] font-black text-white uppercase tracking-widest">Live Load</span>
                                        <span className="text-[9px] font-bold text-slate-500">({draft.length} Selected)</span>
                                     </div>
                                     {/* DOCK SAVE BUTTON */}
                                    <button onClick={saveCurrentSlot} className="px-5 py-2 bg-indigo-600 text-white rounded-full text-[8px] font-black uppercase tracking-widest shadow-lg hover:bg-indigo-500 whitespace-nowrap">
                                       Save Session
                                    </button>
                                </div>

                                {/* Live Bar Chart */}
                                <div className="grid grid-cols-10 gap-1 h-16 items-end overflow-x-auto">
                                     {['Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Quads', 'Hamstrings', 'Glutes', 'Calves', 'Core'].map(group => {
                                         // Calculate Real-Time Score for this Group
                                         const score = draft.reduce((acc, ex) => {
                                             const impact = getImpact(ex);
                                             // Map specific muscles to broad groups
                                             const matchScore = impact.reduce((s, i) => {
                                                 const m = i.muscle; 
                                                 let match = false;
                                                 if (group === 'Chest' && m.includes('Chest')) match = true;
                                                 if (group === 'Back' && (m === 'Lats' || m === 'Mid Back' || m.includes('Trap') || m.includes('Rhomboids') || m.includes('Erector') || m.includes('Back'))) match = true;
                                                 if (group === 'Shoulders' && (m.includes('Delt') || m.includes('Rotator') || m.includes('Supraspinatus'))) match = true;
                                                 if (group === 'Biceps' && (m === 'Biceps' || m.includes('Brach'))) match = true;
                                                 if (group === 'Triceps' && m === 'Triceps') match = true;
                                                 if (group === 'Quads' && m === 'Quads') match = true;
                                                 if (group === 'Hamstrings' && m === 'Hamstrings') match = true;
                                                 if (group === 'Glutes' && m.includes('Glute')) match = true;
                                                 if (group === 'Calves' && (m === 'Calves' || m === 'Gastrocnemius' || m === 'Soleus')) match = true;
                                                 if (group === 'Core' && (m === 'Abs' || m === 'Obliques' || m === 'Core' || m === 'Lower Back' || m === 'Spinal Erectors' || m === 'Serratus')) match = true;
                                                 return match ? s + i.score : s;
                                             }, 0);
                                             // Double volume for unilateral exercises
                                             return acc + (matchScore * (ex.unilateral ? 2 : 1));
                                         }, 0);

                                         // Normalize (Cap visual at 300 points)
                                         const pct = Math.min(100, (score / 300) * 100);
                                         
                                         return (
                                             <div key={group} className="flex flex-col items-center gap-1 h-full justify-end group cursor-pointer" onClick={() => setFilter(group.toUpperCase())}>
                                                 <div className="w-full bg-slate-800/50 rounded-t-md relative h-full overflow-hidden">
                                                     <div className={`absolute bottom-0 left-0 right-0 transition-all duration-500 ${pct >= 100 ? 'bg-emerald-500' : 'bg-indigo-500'}`} style={{height: `${pct}%`}} />
                                                 </div>
                                                 <span className="text-[6px] font-black text-slate-500 uppercase tracking-tighter group-hover:text-white leading-tight -rotate-45 mb-2 origin-left whitespace-nowrap">{group}</span>
                                             </div>
                                         );
                                     })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const SessionDebrief = ({ duration, volume, debriefData, onComplete }) => {
            const [rpe, setRpe] = useState(7);
            const [notes, setNotes] = useState("");

            // Calculate total sets and exercises
            const totalExercises = debriefData?.workout?.exercises?.length || 0;
            const totalSets = debriefData?.workout?.exercises?.reduce((acc, ex) => acc + (ex?.sets?.length || 0), 0) || 0;

            return (
                <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in">
                    <div className="w-full max-w-sm space-y-8">
                        <div className="text-center space-y-2">
                            <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">Mission<br/><span className="text-emerald-500">Debrief</span></h2>
                            <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Session Complete â€¢ {Math.floor(duration / 60)}m</p>
                        </div>
        
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Volume</p>
                                    <p className="text-2xl font-black text-white italic">{volume} <span className="text-sm text-slate-500 not-italic ml-1">kg</span></p>
                                </div>
                                <div>
                                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Work</p>
                                    <p className="text-2xl font-black text-white italic">{totalExercises} <span className="text-sm text-slate-500 not-italic ml-1">EX</span> â€¢ {totalSets} <span className="text-sm text-slate-500 not-italic ml-1">SETS</span></p>
                                </div>
                            </div>
                        </div>
        
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Perceived Exertion (RPE)</label>
                            <div className="grid grid-cols-5 gap-2">
                                {[6, 7, 8, 9, 10].map(r => (
                                    <button key={r} onClick={() => setRpe(r)} className={`p-4 rounded-2xl font-black text-xl italic transition-all ${rpe === r ? 'bg-emerald-500 text-black scale-105 shadow-lg' : 'bg-slate-900 text-slate-600 border border-white/5'}`}>
                                        {r}
                                    </button>
                                ))}
                            </div>
                            <div className="flex justify-between text-[8px] font-bold text-slate-600 uppercase">
                                <span>Moderate</span>
                                <span>Max Effort</span>
                            </div>
                        </div>
        
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Captain's Log</label>
                            <textarea value={notes} onChange={e => setNotes(e.target.value)} className="w-full h-32 bg-slate-900 rounded-3xl p-5 text-xs text-white border-none focus:ring-2 focus:ring-emerald-500" placeholder="Session notes, injuries, or observations..." />
                        </div>
        
                        <button onClick={() => onComplete({ rpe, notes })} className="w-full py-5 bg-emerald-500 text-black rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-xl hover:scale-105 transition-transform">
                            Finalize Log
                        </button>
                    </div>
                </div>
            );
        };

        const WelcomeWizard = ({ onComplete }) => {
            const [step, setStep] = useState(1);
            const [profile, setProfile] = useState({ name: '', units: 'KG', bodyweight: '' });

            if (step === 1) {
                return (
                    <div className="fixed inset-0 z-[300] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in">
                        <div className="w-full max-w-sm space-y-8 text-center">
                            <div className="space-y-2">
                                <h1 className="text-4xl font-black italic uppercase tracking-tighter text-white">Welcome<br/><span className="text-indigo-500">Commander</span></h1>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Tytax Elite System Initialization</p>
                            </div>
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Identify Yourself</label>
                                <input value={profile.name} onChange={e => setProfile({...profile, name: e.target.value})} className="w-full p-5 bg-slate-900 rounded-2xl text-center font-black text-white text-lg border border-white/5 focus:border-indigo-500 focus:ring-0" placeholder="Captain's Name" />
                            </div>
                            <button disabled={!profile.name} onClick={() => setStep(2)} className="w-full py-5 bg-indigo-600 text-white rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-xl disabled:opacity-50">Next Step</button>
                        </div>
                    </div>
                );
            }
            if (step === 2) {
                 return (
                    <div className="fixed inset-0 z-[300] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in">
                        <div className="w-full max-w-sm space-y-8 text-center">
                            <div className="space-y-2">
                                <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">System<br/><span className="text-indigo-500">Calibration</span></h2>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Select Weight Units</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                {['KG', 'LBS'].map(u => (
                                    <button key={u} onClick={() => setProfile({...profile, units: u})} className={`p-8 rounded-3xl font-black text-2xl italic border transition-all ${profile.units === u ? 'bg-indigo-600 text-white border-transparent scale-105' : 'bg-slate-900 text-slate-600 border-white/5'}`}>
                                        {u}
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setStep(3)} className="w-full py-5 bg-indigo-600 text-white rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-xl">Confirm</button>
                        </div>
                    </div>
                );
            }
            // Step 3: Bodyweight (Optional but requested as part of profile)
            if (step === 3) {
                 return (
                    <div className="fixed inset-0 z-[300] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in">
                        <div className="w-full max-w-sm space-y-8 text-center">
                            <div className="space-y-2">
                                <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">Biometric<br/><span className="text-indigo-500">Scan</span></h2>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Current Bodyweight ({profile.units})</p>
                            </div>
                             <div className="space-y-4">
                                <input type="number" value={profile.bodyweight} onChange={e => setProfile({...profile, bodyweight: e.target.value})} className="w-full p-5 bg-slate-900 rounded-2xl text-center font-black text-white text-3xl border border-white/5 focus:border-indigo-500 focus:ring-0" placeholder="0.0" />
                            </div>
                            <button onClick={() => onComplete(profile)} className="w-full py-5 accent-gradient text-white rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-xl">Initialize System</button>
                        </div>
                    </div>
                );
            }
        };

        const HistoryEditor = ({ log, onSave, onCancel }) => {
            const [editedLog, setEditedLog] = useState(JSON.parse(JSON.stringify(log)));

            const updateSet = (exIdx, sIdx, field, value) => {
                const newLog = structuredClone(editedLog);
                newLog.exercises[exIdx].sets[sIdx][field] = value;
                setEditedLog(newLog);
            };

            const handleSave = () => {
                const newVol = editedLog.exercises.reduce((acc, ex) => {
                    const exVol = ex.sets.reduce((sAcc, s) => sAcc + (parseFloat(s.kg) * parseFloat(s.reps) || 0), 0);
                    return acc + (exVol * (ex.unilateral ? 2 : 1));
                }, 0);
                onSave({...editedLog, volume: newVol});
            };

            return (
                <div className="fixed inset-0 z-[250] bg-black/95 backdrop-blur-xl flex flex-col p-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-black italic uppercase tracking-tighter text-white">Edit<br/><span className="text-indigo-500">Record</span></h2>
                        <button onClick={onCancel} className="p-4 bg-slate-900 rounded-2xl text-slate-500"><Icon name="x" /></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto space-y-8 pb-32 no-scrollbar">
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest px-2">Session Notes</label>
                            <textarea value={editedLog.notes || ''} onChange={e => setEditedLog({...editedLog, notes: e.target.value})} className="w-full bg-slate-900 rounded-3xl p-5 text-xs text-white border-none focus:ring-2 focus:ring-indigo-500" rows="3" />
                        </div>

                        {editedLog.exercises.map((ex, exIdx) => (
                            <div key={exIdx} className="space-y-4 bg-slate-900/40 p-6 rounded-[2.5rem] border border-white/5">
                                <h3 className="text-sm font-black text-white italic uppercase tracking-tight">{cleanName(ex.name)}</h3>
                                <div className="space-y-2">
                                    {ex.sets.map((set, sIdx) => (
                                        <div key={sIdx} className="grid grid-cols-3 gap-2">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[8px] font-black text-slate-600 uppercase tracking-widest">KG</label>
                                                <input type="number" value={set.kg} onChange={e => updateSet(exIdx, sIdx, 'kg', e.target.value)} className="w-full p-3 bg-black rounded-xl text-white font-black text-xs border-none" />
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Reps</label>
                                                <input type="number" value={set.reps} onChange={e => updateSet(exIdx, sIdx, 'reps', e.target.value)} className="w-full p-3 bg-black rounded-xl text-white font-black text-xs border-none" />
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[8px] font-black text-slate-600 uppercase tracking-widest">RIR</label>
                                                <select value={set.rir} onChange={e => updateSet(exIdx, sIdx, 'rir', e.target.value)} className="w-full p-3 bg-black rounded-xl text-indigo-400 font-black text-xs border-none">
                                                    <option value="">-</option>
                                                    {[0,1,2,3,4].map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="fixed bottom-8 left-6 right-6">
                        <button onClick={handleSave} className="w-full py-5 accent-gradient text-white rounded-[2rem] font-black uppercase tracking-[0.2em] shadow-2xl">Update Archive</button>
                    </div>
                </div>
            );
        };

        const GlobalHeatmap = ({ globalImpact }) => {
            const [isOpen, setIsOpen] = useState(false);

            return (
                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full flex items-center justify-between group"
                    >
                        <div className="flex items-center gap-3">
                            <Icon name="trends" className="text-indigo-500 w-6 h-6" />
                            <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Global Heatmap</h3>
                        </div>
                        <div className={`p-3 rounded-2xl bg-slate-900 border border-white/5 text-slate-500 transition-all duration-300 ${isOpen ? 'rotate-180 bg-indigo-600 text-white border-transparent' : 'group-hover:text-white'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4">
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </button>

                    {isOpen && (
                        <div className="space-y-3 animate-fade-in">
                            {globalImpact.map((item, i) => (
                                <div key={i} className="space-y-1">
                                    <div className="flex justify-between text-[9px] font-black uppercase tracking-widest text-slate-400">
                                        <span>{item.muscle}</span>
                                        <span>{item.score}</span>
                                    </div>
                                    <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                                        <div className="h-full bg-indigo-500" style={{ width: `${item.pct}%` }} />
                                    </div>
                                </div>
                            ))}
                            <p className="text-[9px] text-slate-500 font-bold italic text-center pt-2">Protocol Target Load Distribution</p>
                        </div>
                    )}
                </div>
            );
        };

        const ExerciseSwapper = ({ targetName, masterExercises, userInventory, onSwap, onCancel }) => {
            const [search, setSearch] = useState('');
            const targetEx = masterExercises.find(e => e.name === targetName);
            
            const candidates = useMemo(() => {
                return masterExercises.filter(ex => {
                    if (ex.name === targetName) return false;
                    
                    // Inventory Check
                    const att = getAttachment(ex.name, PRESETS);
                    if (att && !userInventory.includes(att.name) && att.priority !== 'Owned') return false;

                    // Context Filter
                    if (search.length > 2) return ex.name.toLowerCase().includes(search.toLowerCase());

                    const targetMuscle = targetEx ? (targetEx.muscle_group || getImpact(targetEx)[0]?.muscle) : null;
                    const exMuscle = ex.muscle_group || getImpact(ex)[0]?.muscle;
                    
                    const muscleMatch = targetMuscle && exMuscle && normalizeMuscleName(targetMuscle) === normalizeMuscleName(exMuscle);
                    const patternMatch = targetEx ? (targetEx.pattern && ex.pattern && targetEx.pattern === ex.pattern) : false;
                    
                    return muscleMatch || patternMatch;
                }).sort((a, b) => a.name.localeCompare(b.name));
            }, [search, targetName, masterExercises, userInventory]);

            return (
                <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex flex-col p-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-black italic uppercase tracking-tighter text-white">Swap<br/><span className="text-indigo-500">Exercise</span></h2>
                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Replacing: {cleanName(targetName)}</p>
                        </div>
                        <button onClick={onCancel} className="p-4 bg-slate-900 rounded-2xl text-slate-500"><Icon name="x" /></button>
                    </div>

                    <input
                        value={search}
                        onChange={e => setSearch(e.target.value)}
                        placeholder="Search alternatives..."
                        className="w-full p-4 bg-slate-900 rounded-2xl font-bold text-xs text-white border-none focus:ring-2 focus:ring-indigo-500 mb-4"
                        autoFocus
                    />

                    <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar pb-10">
                        {candidates.length > 0 ? (
                            candidates.map(ex => (
                                <button
                                    key={ex.name}
                                    onClick={() => onSwap(ex)}
                                    className="w-full p-5 bg-slate-900/50 border border-white/5 rounded-[2rem] text-left hover:bg-indigo-900/20 hover:border-indigo-500/50 transition-all group"
                                >
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h4 className="font-black text-sm text-white italic group-hover:text-indigo-300">{cleanName(ex.name)}</h4>
                                            <div className="flex gap-2 mt-2">
                                                <span className="px-2 py-1 bg-slate-800 rounded-lg text-[8px] font-black text-slate-500 uppercase">{ex.station}</span>
                                                <span className="px-2 py-1 bg-slate-800 rounded-lg text-[8px] font-black text-slate-500 uppercase">{ex.pattern || 'Isolation'}</span>
                                            </div>
                                        </div>
                                        {ex.unilateral && <span className="text-[8px] font-black text-purple-400 uppercase tracking-widest border border-purple-500/30 px-2 py-1 rounded-lg">Uni</span>}
                                    </div>
                                </button>
                            ))
                        ) : (
                            <div className="text-center py-10 opacity-50">
                                <p className="text-[10px] font-black uppercase tracking-widest">No context matches found.</p>
                                <p className="text-[9px] text-slate-500">Try searching by name or broaden your inventory.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-black flex items-center justify-center p-10 text-center">
                            <div className="space-y-6">
                                <h1 className="text-4xl font-black text-red-500 uppercase tracking-tighter italic">System Failure</h1>
                                <p className="text-xs text-slate-500 font-mono">Critical runtime error. Attempting recovery.</p>
                                <div className="flex flex-col gap-4">
                                    <button onClick={() => window.location.reload()} className="px-8 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg hover:bg-indigo-500">Reload System</button>
                                    <button onClick={() => { if(confirm("WARNING: This will delete all logs and settings. Continue?")) { localStorage.clear(); window.location.reload(); } }} className="text-[10px] font-black text-red-500/50 uppercase tracking-widest hover:text-red-500 transition-colors">Factory Reset (Data Wipe)</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const App = () => {
            // --- PERSISTENCE ---
            const [activeTab, setActiveTab] = useState('home');
            const [logs, setLogs] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_logs') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_logs from localStorage", e);
                    return [];
                }
            });
            const [sessionOrder, setSessionOrder] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_session_order') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_session_order from localStorage", e);
                    return [];
                }
            });
            const [trainingPlan, setTrainingPlan] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_training_plan') || '{}');
                } catch (e) {
                    console.error("Error parsing tytax_training_plan from localStorage", e);
                    return {};
                }
            });
            const [masterExercises, setMasterExercises] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_master_exercises') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_master_exercises from localStorage", e);
                    return [];
                }
            });
            const [setupNotes, setSetupNotes] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_setup_notes') || '{}');
                } catch (e) {
                    console.error("Error parsing tytax_setup_notes from localStorage", e);
                    return {};
                }
            });
            const [startDate, setStartDate] = useState(() => localStorage.getItem('tytax_start_date') || new Date().toISOString().split('T')[0]);
            const [oledMode, setOledMode] = useState(() => localStorage.getItem('tytax_oled_mode') === 'true');
            const [warmupStrategy, setWarmupStrategy] = useState(() => localStorage.getItem('tytax_warmup_strategy') || 'Standard');
            const [userInventory, setUserInventory] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_inventory') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_inventory from localStorage", e);
                    return [];
                }
            });
            const [userProfile, setUserProfile] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_user_profile') || 'null');
                } catch (e) {
                    console.error("Error parsing tytax_user_profile from localStorage", e);
                    return null;
                }
            });
            const [bodyweightLog, setBodyweightLog] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_bodyweight_log') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_bodyweight_log from localStorage", e);
                    return [];
                }
            });

            // --- CUSTOM PROTOCOLS ---
            const [customProtocols, setCustomProtocols] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('tytax_custom_protocols') || '[]');
                } catch (e) {
                    console.error("Error parsing tytax_custom_protocols from localStorage", e);
                    return [];
                }
            });
            const allPresets = [...PRESETS, ...customProtocols];

            const [library, setLibrary] = useState(() => {
                // Initialize library with preset data if available, otherwise empty (will be populated on load)
                const p = allPresets.find(pr => pr.id === 'kinetic_impact') || PRESETS[0];
                return p?.data.MASTER_EXERCISES || [];
            });

            useEffect(() => {
                document.body.style.backgroundColor = oledMode ? '#000000' : '#020617';
            }, [oledMode]);

            // --- DATA MIGRATION CHECK ---
            useEffect(() => {
                // Check if we need to upgrade to Kinetic Impact data
                const currentPreset = allPresets.find(p => p.id === 'kinetic_impact');
                if (currentPreset && masterExercises.length > 0) {
                    const needsUpgrade = masterExercises.some(ex => !ex.note && currentPreset.data.MASTER_EXERCISES.some(nex => cleanName(nex.name) === cleanName(ex.name)));

                    if (needsUpgrade) {
                        if (confirm("New Kinetic Impact protocol available. Update your library? (Recommended)")) {
                            applyLibraryData(currentPreset.data);
                            showToast("System Upgraded");
                        }
                    }
                }
            }, []);

            // --- UI STATES ---
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedSession, setSelectedSession] = useState(null); 
            const [currentWorkout, setCurrentWorkout] = useState(null); 
            const [libraryInput, setLibraryInput] = useState(""); 
            const [toast, setToast] = useState(null); 
            const [stopwatch, setStopwatch] = useState(0); 
            const [timer, setTimer] = useState(0); 
            const [timerActive, setTimerActive] = useState(false); 
            const [calculatorTarget, setCalculatorTarget] = useState(null);
            const [showOneRepMax, setShowOneRepMax] = useState(false);
            const [prCelebration, setPrCelebration] = useState(null); // Array of PRs or null
            const [focusMode, setFocusMode] = useState(false);
            const [debriefData, setDebriefData] = useState(null);
            const [swappingIdx, setSwappingIdx] = useState(null);
            const [editingLog, setEditingLog] = useState(null);
 
            useEffect(() => { 
                localStorage.setItem('tytax_logs', JSON.stringify(logs)); 
                localStorage.setItem('tytax_session_order', JSON.stringify(sessionOrder)); 
                localStorage.setItem('tytax_training_plan', JSON.stringify(trainingPlan)); 
                localStorage.setItem('tytax_master_exercises', JSON.stringify(masterExercises)); 
                localStorage.setItem('tytax_setup_notes', JSON.stringify(setupNotes)); 
                localStorage.setItem('tytax_start_date', startDate); 
                localStorage.setItem('tytax_oled_mode', oledMode);
                localStorage.setItem('tytax_warmup_strategy', warmupStrategy);
                localStorage.setItem('tytax_inventory', JSON.stringify(userInventory));
                localStorage.setItem('tytax_user_profile', JSON.stringify(userProfile));
                localStorage.setItem('tytax_bodyweight_log', JSON.stringify(bodyweightLog));
            }, [logs, sessionOrder, trainingPlan, masterExercises, setupNotes, startDate, oledMode, warmupStrategy, userInventory, userProfile, bodyweightLog]); 
 
            useEffect(() => { 
                let interval; 
                if (timerActive && timer > 0) {
                    interval = setInterval(() => setTimer(t => t - 1), 1000); 
                } else if (timer === 0 && timerActive) {
                    setTimerActive(false);
                    
                    // --- ENHANCED FEEDBACK SEQUENCE ---
                    // 1. Haptic Pulse (Double Tap)
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

                    // 2. Audio Oscillator (Clean Beep)
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (AudioContext) {
                            const ctx = new AudioContext();
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            
                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(880, ctx.currentTime); 
                            osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.2);
                            
                            gain.gain.setValueAtTime(0.1, ctx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
                            
                            osc.start();
                            osc.stop(ctx.currentTime + 0.2);
                        }
                    } catch(e) { console.error("Audio blocked", e); }

                    // 3. Voice Synthesis
                    if ('speechSynthesis' in window) {
                        window.speechSynthesis.cancel();
                        const u = new SpeechSynthesisUtterance("Rest complete");
                        u.rate = 1.2;
                        u.pitch = 1.0;
                        window.speechSynthesis.speak(u);
                    }
                } 
                return () => clearInterval(interval); 
            }, [timerActive, timer]); 
 
            useEffect(() => { 
                let interval; 
                if (currentWorkout) interval = setInterval(() => setStopwatch(s => s + 1), 1000); 
                else setStopwatch(0); 
                return () => clearInterval(interval); 
            }, [currentWorkout]); 

            // Scroll Reset on Tab Change
            useEffect(() => window.scrollTo(0,0), [activeTab]);

            // Input Manager (Keyboard Shortcuts & Wake Lock)
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.code === 'Space' && activeTab === 'workout') {
                        // Toggle timer if active, or just prevent default scrolling
                        if (document.activeElement.tagName !== 'INPUT') {
                            e.preventDefault();
                            if (timerActive) setTimerActive(false);
                        }
                    }
                    if (e.code === 'Escape') {
                        setCalculatorTarget(null);
                        setShowOneRepMax(false);
                        setPrCelebration(null);
                    }
                };
                window.addEventListener('keydown', handleKey);

                let wakeLock = null;
                const requestWakeLock = async () => {
                    if (activeTab === 'workout' && 'wakeLock' in navigator) {
                        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
                    }
                };
                requestWakeLock();

                return () => {
                    window.removeEventListener('keydown', handleKey);
                    if (wakeLock) wakeLock.release();
                };
            }, [activeTab, timerActive]);
 
            const showToast = (m) => { setToast(m); setTimeout(() => setToast(null), 3000); }; 

            const exportCSV = () => {
                const headers = ["Date,Session,Exercise,Set,KG,Reps,RIR,e1RM"];
                const rows = logs.flatMap(l => l.exercises.flatMap(e => e.sets.filter(s => s.done).map((s, i) => `${new Date(l.date).toLocaleDateString()},${l.session},"${e.name}",${i+1},${s.kg},${s.reps},${s.rir},${calculateE1RM(s.kg, s.reps)}`)));
                const blob = new Blob([headers.concat(rows).join("\n")], { type: "text/csv" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "tytax_training_log.csv"; a.click();
            };
 
            const applyLibraryData = (data) => { 
                const cleanExercises = data.MASTER_EXERCISES.map(ex => ({ 
                    ...ex, name: ex.name.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim() 
                })); 
                const cleanPlan = {}; 
                Object.entries(data.INITIAL_PLAN).forEach(([key, list]) => { 
                    cleanPlan[key] = list.map(name => name.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim()); 
                }); 
                setMasterExercises(cleanExercises); 
                setLibrary(cleanExercises); // Populate meta-library for Builder
                setTrainingPlan(cleanPlan); 
                setSessionOrder(data.INITIAL_ORDER || Object.keys(cleanPlan)); 
            }; 
 
            const loadPreset = (p) => { applyLibraryData(p.data); showToast(`${p.name} Active`); setActiveTab('workout'); }; 
            const importJSON = () => { try { applyLibraryData(JSON.parse(libraryInput)); showToast("Custom Protocol Loaded"); setLibraryInput(""); setActiveTab('workout'); } catch(e) { showToast("Invalid Protocol JSON"); } }; 
 
            const getPredictedSession = (d) => { 
                if (!sessionOrder.length) return null; 
                const diff = Math.floor((new Date(d) - new Date(startDate)) / 86400000); 
                return sessionOrder[((diff % sessionOrder.length) + sessionOrder.length) % sessionOrder.length]; 
            }; 
 
            const startWorkout = () => { 
                // FATIGUE CHECK
                let isDeload = false;
                if (recoveryStatus.status === 'Fried') {
                    if (confirm("System Alert: High Fatigue Detected.\n\nEngage Recovery Protocol? (-1 Set, -15% Load)")) {
                        isDeload = true;
                    }
                }

                // GAP ANALYSIS
                const laggingMuscle = getLaggingMuscle(logs, masterExercises);

                const sess = selectedSession || getPredictedSession(selectedDate); 
                const items = trainingPlan[sess] || []; 
                
                // VOLUME PARITY FIX: Scan all history for best volume
                const sessionHistory = logs.filter(l => l.session === sess);
                const bestVolume = sessionHistory.length ? Math.max(...sessionHistory.map(l => l.volume || 0)) : 0;
                const lastStats = sessionHistory.length ? { volume: bestVolume, duration: sessionHistory[0].duration } : null;

                // WEAK POINT INJECTOR PROMPT
                let extraExercises = [];
                if (recoveryStatus.status === 'Fresh' && laggingMuscle) {
                    // Find a relevant isolation exercise from library
                    const suggestion = masterExercises.find(ex => 
                        getImpact(ex).some(i => i.muscle === laggingMuscle && i.level === 'Primary') &&
                        !items.includes(ex.name) // Don't suggest if already in session
                    );

                    if (suggestion && confirm(`System Suggestion: Your ${laggingMuscle} volume is low.\n\nAdd 2 sets of "${cleanName(suggestion.name)}" to this session?`)) {
                        extraExercises.push(suggestion.name);
                    }
                }
                
                setCurrentWorkout({ 
                    date: selectedDate, session: sess, lastStats, isDeload, laggingMuscle,
                    exercises: [...items, ...extraExercises].map(name => { 
                        const m = masterExercises.find(ex => ex.name === name); 
                        
                        // SMART PRE-FILL LOGIC
                        let prefillKg = '';
                        const lastLogForExercise = logs.filter(l => l.exercises.some(e => e.name === name))[0]; // Ensure sorted logs
                        
                        let lastMaxLoad = 0;

                        if (lastLogForExercise) {
                            const lastExerciseData = lastLogForExercise.exercises.find(e => e.name === name);
                            const workingSets = lastExerciseData.sets.filter(s => s.done && (s.type === 'working' || !s.type));
                            if (workingSets.length > 0) {
                                // Find max load for auto-warmups
                                lastMaxLoad = Math.max(...workingSets.map(s => parseFloat(s.kg) || 0));

                                const lastSet = workingSets[workingSets.length - 1];
                                const lastKg = parseFloat(lastSet.kg);
                                const lastRir = parseInt(lastSet.rir || 0);
                                
                                if (!isNaN(lastKg)) {
                                    let increment = 0;
                                    if (lastRir >= 3) increment = 2.5;
                                    else if (lastRir >= 2) increment = 1.25;
                                    
                                    prefillKg = (lastKg + increment);
                                }
                            }
                        }

                        // DELOAD ADJUSTMENTS
                        if (isDeload && prefillKg) {
                            prefillKg = (parseFloat(prefillKg) * 0.85).toFixed(1);
                        } else if (prefillKg) {
                            prefillKg = prefillKg.toString();
                        }

                        let targetSetsCount = parseInt(m?.sets || 3);
                        if (isDeload) targetSetsCount = Math.max(1, targetSetsCount - 1);
                        if (extraExercises.includes(name)) targetSetsCount = 2; // Force 2 sets for extra exercises

                        const workingSets = Array.from({length: targetSetsCount}, () => ({ kg: prefillKg, reps: '', rir: '', done: false, type: 'working' }));
                        const warmupSets = generateWarmups(lastMaxLoad, warmupStrategy);

                        return { 
                            name, 
                            station: m?.station || "Tytax", 
                            unilateral: m?.unilateral || false,
                            impact: m?.impact || [],
                            targetReps: m?.reps || "8-12", 
                            note: m?.note || "", 
                            sets: [...warmupSets, ...workingSets], 
                            setup: setupNotes[name] || "" 
                        };
                    }) 
                }); 
            }; 
 
            const currentVolume = useMemo(() => { 
                if (!currentWorkout) return 0; 
                return currentWorkout.exercises.reduce((acc, ex) => {
                    const exerciseVol = ex.sets.reduce((sAcc, s) => {
                        // Exclude warmup sets from "Volume Parity" calculation
                        if (s.type === 'warmup') return sAcc;
                        return sAcc + (parseFloat(s.kg) * parseFloat(s.reps) || 0);
                    }, 0);
                    // Double volume for unilateral exercises
                    return acc + (exerciseVol * (ex.unilateral ? 2 : 1));
                }, 0); 
            }, [currentWorkout]); 

            const globalImpact = useMemo(() => {
                return calculateImpactDistribution(masterExercises, false);
            }, [masterExercises]);

            const recoveryStatus = useMemo(() => {
                if (!logs.length) return { status: 'Fresh', pct: 100, color: 'text-emerald-500', barColor: 'bg-emerald-500' };
                
                const getKineticLoad = (sessionLogs, useDecay = false) => {
                    return sessionLogs.reduce((acc, log) => {
                        const sessionImpact = calculateImpactDistribution(log.exercises, true);
                        const sessionScore = sessionImpact.reduce((sAcc, item) => sAcc + item.score, 0);
                        
                        let weight = 1;
                        if (useDecay) {
                            const hoursSince = (new Date() - new Date(log.date)) / (1000 * 60 * 60);
                            weight = Math.max(0, 1 - (hoursSince / 48)); // Linear decay over 48h
                        }
                        
                        return acc + (sessionScore * weight);
                    }, 0);
                };

                // HELPER: Get realistic baseline weight for protocol average
                const getBaselineWeight = (ex) => {
                    // SAFETY FIX: Prevent crash if exercise mismatch occurs
                    if (!ex) return 10; 
                    
                    const p = (ex.pattern || "").toLowerCase();
                    if (p.includes("squat") || p.includes("deadlift") || p.includes("leg press")) return 60;
                    if (p.includes("chest press") || p.includes("row") || p.includes("pulldown")) return 40;
                    if (p.includes("shoulder") || p.includes("pull-up")) return 30;
                    return 10; // Isolations
                };

                // 1. Calculate Protocol Baseline (Cold Start Floor)
                const protocolWeeklyLoad = Object.values(trainingPlan).reduce((acc, sessionExercises) => {
                    const simExercises = sessionExercises.map(name => {
                        const m = masterExercises.find(ex => ex.name === name);
                        // USE WEIGHTED BASELINE HERE
                        return { ...m, sets: Array.from({length: parseInt(m?.sets || 3)}, () => ({ kg: getBaselineWeight(m), reps: 10, done: true })) };
                    });
                    const sessionImpact = calculateImpactDistribution(simExercises, true);
                    return acc + sessionImpact.reduce((s, i) => s + i.score, 0);
                }, 0);
                const protocolDailyAverage = protocolWeeklyLoad / 7;

                // 2. Calculate ACWR (Acute:Chronic Workload Ratio)
                const now = new Date();
                
                // Chronic Load (30 Days) - No decay needed for chronic baseline
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                const chronicLogs = logs.filter(l => new Date(l.date) > thirtyDaysAgo);
                const chronicLoadTotal = getKineticLoad(chronicLogs, false);
                const chronicLoadAvg = chronicLoadTotal / 30;
                
                // Apply "Cold Start" Floor
                const adjustedChronicLoad = Math.max(chronicLoadAvg, protocolDailyAverage * 0.8);

                // Acute Load (48 Hours) - WITH TIME DECAY
                const twoDaysAgo = new Date(now.getTime() - 48 * 24 * 60 * 60 * 1000);
                const acuteLogs = logs.filter(l => new Date(l.date) > twoDaysAgo);
                const acuteLoadWeighted = getKineticLoad(acuteLogs, true) * 2; // Normalize back to "load intensity" since decay reduces sum

                const ratio = acuteLoadWeighted / adjustedChronicLoad;

                // 3. Determine Status
                // Check history depth for tightened first-week thresholds
                const firstLogDate = logs.length > 0 ? new Date(Math.min(...logs.map(l => l.date))) : new Date();
                const daysHistory = (now - firstLogDate) / (1000 * 60 * 60 * 24);

                // If no logs, assume "Fresh" status
                const isNewUser = logs.length === 0 || daysHistory < 7;

                const limitRecovering = isNewUser ? 1.2 : 1.5;
                const limitFried = isNewUser ? 1.7 : 2.0;

                let score = 100;
                if (ratio > limitFried) score = 30;
                else if (ratio > limitRecovering) score = 60;
                else score = 100;

                // Smooth score logic for UI
                if (ratio <= 1.0) score = 100;
                else if (ratio >= limitFried) score = 20;
                else score = 100 - ((ratio - 1.0) * (80 / (limitFried - 1.0)));

                if (score > 80) return { status: 'Fresh', pct: score, color: 'text-emerald-500', barColor: 'bg-emerald-500' };
                if (score > 40) return { status: 'Recovering', pct: score, color: 'text-yellow-500', barColor: 'bg-yellow-500' };
                return { status: 'Fried', pct: score, color: 'text-red-500', barColor: 'bg-red-500' };
            }, [logs, trainingPlan, masterExercises]);
 
            return ( 
                <div className="min-h-screen bg-[#020617] text-slate-200 font-inter selection:bg-indigo-500/30 md:flex">
                    
                    {/* DESKTOP SIDEBAR (Visible md+) */}
                    <aside className="hidden md:flex flex-col w-64 h-screen sticky top-0 border-r border-white/5 bg-[#020617] p-6 z-50">
                        <div className="flex items-center gap-3 mb-10 px-2">
                            <div className="p-2 accent-gradient rounded-xl shadow-lg shadow-indigo-500/20">
                                <Icon name="bolt" className="text-white w-6 h-6" />
                            </div>
                            <h1 className="font-black text-2xl tracking-tighter italic leading-none">TYTAX<span className="text-indigo-500">ELITE</span></h1>
                        </div>
                        
                        <nav className="space-y-2 flex-1">
                            {[ 
                                { id: 'home', icon: 'home', label: 'Home' }, 
                                { id: 'workout', icon: 'bolt', label: 'Gym' }, 
                                { id: 'trends', icon: 'trends', label: 'Trends' }, 
                                { id: 'history', icon: 'history', label: 'Vault' },
                                { id: 'builder', icon: 'tool', label: 'Builder' },
                                { id: 'features', icon: 'info', label: 'Manual' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all group ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-900 hover:text-white'}`}>
                                    <Icon name={tab.icon} className={`w-5 h-5 ${activeTab === tab.id ? 'text-white' : 'text-slate-500 group-hover:text-indigo-400'}`} />
                                    <span className="text-[10px] font-black uppercase tracking-widest">{tab.label}</span>
                                </button>
                            ))}
                        </nav>

                        {/* Desktop System Status Mini-Widget */}
                        <div className="bg-slate-900/50 rounded-2xl p-4 border border-white/5 space-y-2">
                            <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-widest text-slate-500">
                                <span>System</span>
                                <span className={sessionOrder.length > 0 ? "text-emerald-500" : "text-red-500"}>{sessionOrder.length > 0 ? "Online" : "Standby"}</span>
                            </div>
                            <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-widest text-slate-500">
                                <span>Recovery</span>
                                <span className={recoveryStatus.color}>{recoveryStatus.status}</span>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 p-6 md:p-10 pb-32 md:pb-10 overflow-y-auto max-w-7xl mx-auto w-full"> 
                        {editingLog && (
                            <HistoryEditor 
                                log={editingLog} 
                                onSave={(updatedLog) => {
                                    setLogs(logs.map(l => l.id === updatedLog.id ? updatedLog : l));
                                    setEditingLog(null);
                                    showToast("Log Updated");
                                }}
                                onCancel={() => setEditingLog(null)}
                            />
                        )}

                        {debriefData && <SessionDebrief duration={debriefData.duration} onComplete={(data) => {
                             // PR LOGIC
                             const { workout, duration, volume } = debriefData;
                             const finalWorkout = { ...workout, rpe: data.rpe, notes: data.notes, id: Date.now(), duration, volume };
                             
                             const newPRs = [];
                             finalWorkout.exercises.forEach(ex => {
                                const currentBest = Math.max(...ex.sets.map(s => calculateE1RM(s.kg, s.reps)));
                                // Find historical best
                                const history = logs.filter(l => l.exercises.some(e => e.name === ex.name));
                                let historicalBest = 0;
                                history.forEach(l => {
                                    const hEx = l.exercises.find(e => e.name === ex.name);
                                    const hMax = Math.max(...hEx.sets.map(s => calculateE1RM(s.kg, s.reps)));
                                    if (hMax > historicalBest) historicalBest = hMax;
                                });

                                if (currentBest > historicalBest && historicalBest > 0) {
                                    newPRs.push({ exercise: ex.name, kg: currentBest, diff: (currentBest - historicalBest).toFixed(1) });
                                }
                            });

                            setLogs([finalWorkout, ...logs]);
                            
                            setDebriefData(null);
                            setCurrentWorkout(null); 
                            setActiveTab('history'); 
                            setFocusMode(false);

                            if (newPRs.length > 0) {
                                setPrCelebration(newPRs);
                            } else {
                                showToast("Protocol Logged"); 
                            }
                        }} />}

                        {prCelebration && <PRModal prs={prCelebration} onClose={() => setPrCelebration(null)} />}
                        {calculatorTarget && <PlateCalculator targetKg={calculatorTarget.targetKg} onClose={() => setCalculatorTarget(null)} />}
                        {showOneRepMax && <OneRepMaxCalculator onClose={() => setShowOneRepMax(false)} />}
                        {swappingIdx !== null && (
                            <ExerciseSwapper 
                                targetName={currentWorkout.exercises[swappingIdx].name}
                                masterExercises={masterExercises}
                                userInventory={userInventory}
                                onCancel={() => setSwappingIdx(null)}
                                onSwap={(newMaster) => {
                                    const up = structuredClone(currentWorkout);
                                    
                                    // Smart Prefill Logic
                                    const targetSetsCount = parseInt(newMaster.sets || 3);
                                    const workingSets = Array.from({length: targetSetsCount}, () => ({ kg: '', reps: '', rir: '', done: false, type: 'working' }));
                                    
                                    const lastLog = logs.find(l => l.exercises.some(e => e.name === newMaster.name));
                                    let lastMaxLoad = 0;
                                    
                                    if (lastLog) {
                                        const prevExData = lastLog.exercises.find(e => e.name === newMaster.name);
                                        const prevWorking = prevExData.sets.filter(s => s.done && s.type !== 'warmup');
                                        if (prevWorking.length) {
                                            lastMaxLoad = Math.max(...prevWorking.map(s => parseFloat(s.kg) || 0));
                                            const lastSet = prevWorking[prevWorking.length-1];
                                            workingSets.forEach(s => s.kg = lastSet.kg);
                                        }
                                    }
                                    
                                    const warmupSets = generateWarmups(lastMaxLoad, warmupStrategy);

                                    up.exercises[swappingIdx] = {
                                        name: newMaster.name,
                                        station: newMaster.station || "Tytax",
                                        unilateral: newMaster.unilateral || false,
                                        impact: newMaster.impact || [],
                                        targetReps: newMaster.reps || "8-12",
                                        note: newMaster.note || "",
                                        sets: [...warmupSets, ...workingSets],
                                        setup: setupNotes[newMaster.name] || ""
                                    };
                                    
                                    setCurrentWorkout(up);
                                    setSwappingIdx(null);
                                    showToast("Exercise Swapped");
                                }}
                            />
                        )}

                        {(!userProfile && logs.length === 0) && <WelcomeWizard onComplete={(p) => {
                            setUserProfile(p);
                            const defaultProto = PRESETS[0];
                            applyLibraryData(defaultProto.data);
                            showToast(`Welcome, Commander ${p.name}`);
                        }} />}
                        
                        {toast && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[250] bg-indigo-500 text-white px-8 py-4 rounded-3xl shadow-2xl font-black text-[10px] uppercase tracking-widest animate-pulse">{toast}</div>} 
    
                        {timerActive && ( 
                            <div className="fixed bottom-32 left-6 right-6 md:bottom-10 md:left-auto md:right-10 md:w-96 z-[60] bg-indigo-900/90 backdrop-blur-xl rounded-full p-2 shadow-2xl border border-indigo-500/30 flex items-center justify-between pl-4">
                                <div className="flex items-center gap-3">
                                    <Icon name="timer" className="text-indigo-400 w-4 h-4" />
                                    <span className="font-black text-white font-mono text-lg">{Math.floor(timer/60)}:{(timer%60).toString().padStart(2,'0')}</span>
                                </div>
                                <div className="flex gap-1">
                                    <button onClick={() => setTimer(t => t+30)} className="px-3 py-1 bg-white/10 rounded-full text-[10px] font-black text-indigo-300 hover:bg-white/20">+30s</button>
                                    <button onClick={() => setTimerActive(false)} className="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/40"><Icon name="x" className="w-3 h-3" /></button>
                                </div>
                                <div className="absolute bottom-0 left-4 right-4 h-0.5 bg-indigo-500/30">
                                    <div className="h-full bg-indigo-400 timer-progress" style={{width: `${(timer/90)*100}%`}} />
                                </div>
                            </div> 
                        )} 
    
                        {!focusMode && (
                            <header className="md:hidden p-8 flex justify-between items-center sticky top-0 z-40 glass border-none"> 
                                <div className="flex items-center gap-4"> 
                                    <div className="p-3 accent-gradient rounded-2xl shadow-xl shadow-indigo-500/20"> 
                                        <Icon name="bolt" className="text-white w-6 h-6" /> 
                                    </div> 
                                    <div> 
                                        <h1 className="font-black text-2xl tracking-tighter italic leading-none">TYTAX<span className="text-indigo-500">ELITE</span></h1> 
                                        {currentWorkout && <p className="text-[9px] font-black text-slate-500 mt-1 uppercase tracking-widest italic">Live Session: {Math.floor(stopwatch/60)}m</p>} 
                                    </div> 
                                </div> 
                                <button onClick={() => setActiveTab('settings')} aria-label="Settings" className="p-3 bg-slate-900 rounded-2xl text-slate-500 border border-white/5"><Icon name="settings" /></button> 
                            </header> 
                        )}
                        {activeTab === 'home' && ( 
                            <div className="tab-content space-y-10 pb-20"> 
                                {/* SYSTEM STATUS */} 
                                <div className="glass p-10 rounded-[3rem] space-y-8 border-white/5 relative overflow-hidden glow-indigo"> 
                                    <div className="absolute -top-10 -right-10 w-40 h-40 bg-indigo-600/10 blur-[60px]" /> 
                                    <div className="flex items-center justify-between"> 
                                        <div className="flex items-center gap-3"> 
                                            <div className={`w-3 h-3 rounded-full ${sessionOrder.length > 0 ? 'bg-emerald-500 status-pulse shadow-[0_0_15px_rgba(16,185,129,0.5)]' : 'bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]'}`} /> 
                                            <h2 className="text-3xl font-black tracking-tighter italic uppercase leading-none">System<br/><span className={`${sessionOrder.length > 0 ? 'text-indigo-500' : 'text-red-500'}`}>{sessionOrder.length > 0 ? 'Online' : 'Standby'}</span></h2> 
                                        </div> 
                                        {sessionOrder.length === 0 && ( 
                                            <div className="bg-red-900/20 border border-red-500/30 px-3 py-1 rounded-xl animate-pulse"> 
                                                <span className="text-[8px] font-black text-red-500 uppercase tracking-widest">Action Required</span> 
                                            </div> 
                                        )} 
                                    </div> 
                                     
                                    {sessionOrder.length === 0 ? ( 
                                        <div className="space-y-6"> 
                                            <div className="bg-indigo-900/10 p-4 rounded-2xl border border-indigo-500/10"> 
                                                <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Activation Guide</p> 
                                                <p className="text-xs font-bold text-slate-400 mt-2 leading-relaxed italic">Select a preset protocol below to initialize the system. This will go "Online" as soon as a program is selected.</p> 
                                            </div> 
                                            <div className="grid grid-cols-1 gap-3"> 
                                                {allPresets.map(p => ( 
                                                    <button key={p.id} onClick={() => loadPreset(p)} className="p-6 bg-slate-900 rounded-[2rem] border border-indigo-500/30 text-left group hover:border-indigo-500 transition-all shadow-xl"> 
                                                        <h4 className="font-black text-white text-base group-hover:text-indigo-400 italic">Initialize: {p.name}</h4> 
                                                        <p className="text-[9px] font-bold text-slate-500 mt-2 uppercase">{p.description}</p> 
                                                    </button> 
                                                ))} 
                                            </div> 
                                        </div> 
                                    ) : ( 
                                        <div className="space-y-4"> 
                                            <div className="p-6 bg-indigo-900/10 rounded-3xl border border-indigo-500/20"> 
                                                <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Active Sequence</p> 
                                                <p className="text-sm font-black text-white mt-1 italic uppercase tracking-tight">{sessionOrder.join(' â€¢ ')}</p> 
                                            </div> 
                                            <button onClick={() => setActiveTab('workout')} className="w-full py-5 accent-gradient text-white rounded-[2rem] font-black text-[10px] uppercase tracking-[0.4em] shadow-2xl">Enter Training Center</button> 
                                        </div> 
                                    )} 
                                </div> 

                                {/* GAMIFICATION HEADER */}
                                {logs.length > 0 && (
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="glass p-6 rounded-[2.5rem] flex items-center gap-4">
                                            <div className="p-3 bg-orange-500/20 rounded-2xl text-orange-500">
                                                <Icon name="bolt" className="w-6 h-6 animate-pulse" />
                                            </div>
                                            <div>
                                                <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Streak</p>
                                                {/* Calculate Streak */}
                                                <p className="text-2xl font-black text-white italic">{(() => {
                                                    const weeks = new Set(logs.map(l => {
                                                        const d = new Date(l.date);
                                                        const start = new Date(d.getFullYear(), 0, 1);
                                                        const days = Math.floor((d - start) / (24 * 60 * 60 * 1000));
                                                        return `${d.getFullYear()}-W${Math.ceil(days / 7)}`;
                                                    }));
                                                    return weeks.size; // Simple "Active Weeks" count for now as per "Streak" requirement variation
                                                })()} <span className="text-[10px] text-slate-600 not-italic">WEEKS</span></p>
                                            </div>
                                        </div>
                                        <div className="glass p-6 rounded-[2.5rem] flex items-center gap-4">
                                            <div className="p-3 bg-purple-500/20 rounded-2xl text-purple-500">
                                                <Icon name="tool" className="w-6 h-6" />
                                            </div>
                                            <div>
                                                <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Level</p>
                                                <p className="text-2xl font-black text-white italic">{(() => {
                                                    const totalVol = logs.reduce((acc, l) => acc + (l.volume || 0), 0);
                                                    return Math.floor(Math.sqrt(totalVol) / 10) || 1; 
                                                })()}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* RECOVERY STATUS */}
                                {sessionOrder.length > 0 && (
                                    <div className="glass p-8 rounded-[3rem] space-y-4 border-white/5 relative overflow-hidden">
                                        <div className="flex justify-between items-center relative z-10">
                                            <div className="flex items-center gap-3">
                                                <Icon name="shield" className={`w-6 h-6 ${recoveryStatus.color}`} />
                                                <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">System Status</h3>
                                            </div>
                                            <span className={`text-[10px] font-black uppercase tracking-widest ${recoveryStatus.color}`}>{recoveryStatus.status}</span>
                                        </div>
                                        <div className="h-2 bg-slate-800 rounded-full overflow-hidden relative z-10">
                                            <div className={`h-full transition-all duration-1000 ${recoveryStatus.barColor}`} style={{width: `${recoveryStatus.pct}%`}} />
                                        </div>
                                        <p className="text-[9px] text-slate-500 font-bold italic text-center relative z-10">Based on acute volume load (48h)</p>
                                        <div className={`absolute top-0 right-0 w-32 h-32 blur-[50px] opacity-10 ${recoveryStatus.barColor}`} />
                                    </div>
                                )}

                                {/* GLOBAL HEATMAP */}
                                {sessionOrder.length > 0 && <GlobalHeatmap globalImpact={globalImpact} />}
 
                                {/* PROTOCOL SWITCHER (ONLY IF ONLINE) */} 
                                {sessionOrder.length > 0 && ( 
                                    <div className="space-y-4 px-2"> 
                                        <div className="flex items-center gap-2"> 
                                            <Icon name="library" className="text-indigo-500 w-4 h-4" /> 
                                            <h3 className="text-[10px] font-black uppercase text-white tracking-[0.2em]">Protocol Suite</h3> 
                                        </div> 
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2"> 
                                            {allPresets.map(p => ( 
                                                <button key={p.id} onClick={() => loadPreset(p)} className="px-6 py-4 bg-slate-900 rounded-2xl border border-white/5 text-[10px] font-black text-slate-400 whitespace-nowrap uppercase tracking-widest hover:text-white transition-colors"> 
                                                    {p.name} 
                                                </button> 
                                            ))} 
                                        </div> 
                                    </div> 
                                )} 
 
                                {/* QUICK ACTIONS */}
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setShowOneRepMax(true)} className="glass p-6 rounded-[2rem] flex items-center justify-center gap-3 hover:bg-indigo-900/20 transition-colors group border-white/5">
                                        <div className="p-2 bg-slate-900 rounded-xl text-slate-500 group-hover:text-indigo-400 transition-colors"><Icon name="dumbbell" className="w-5 h-5" /></div>
                                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-white">1RM Calc</span>
                                    </button>
                                    <button onClick={() => setActiveTab('features')} className="glass p-6 rounded-[2rem] flex items-center justify-center gap-3 hover:bg-indigo-900/20 transition-colors group border-white/5">
                                        <div className="p-2 bg-slate-900 rounded-xl text-slate-500 group-hover:text-indigo-400 transition-colors"><Icon name="info" className="w-5 h-5" /></div>
                                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-white">System Guide</span>
                                    </button>
                                </div>
                            </div> 
                        )} 
 
                        {activeTab === 'workout' && ( 
                            <div className="tab-content space-y-8 pb-20"> 
                                {sessionOrder.length === 0 ? ( 
                                    <div className="glass p-10 rounded-[3rem] space-y-8 text-center border-red-500/20 bg-red-900/5"> 
                                        <Icon name="bolt" className="w-12 h-12 mx-auto text-red-900 opacity-50" /> 
                                        <div className="space-y-2"> 
                                            <h2 className="text-xl font-black uppercase text-white tracking-widest italic">System Offline</h2> 
                                            <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">No Protocol Loaded. System Standby.</p> 
                                        </div> 
                                        <button onClick={() => setActiveTab('home')} className="w-full py-5 accent-gradient text-white rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] shadow-xl">Activate System on Home Tab</button> 
                                    </div> 
                                ) : !currentWorkout ? ( 
                                    <div className="glass p-10 rounded-[3rem] space-y-10 border-white/5 shadow-2xl"> 
                                        <div className="space-y-2"> 
                                            <h2 className="text-4xl font-black tracking-tighter leading-none italic uppercase">Training<br/><span className="text-indigo-500">Center</span></h2> 
                                            <p className="text-[11px] font-black text-slate-500 uppercase tracking-widest">Recommended: {getPredictedSession(selectedDate) || "---"}</p> 
                                        </div> 
                                        <div className="space-y-6"> 
                                            <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full p-5 bg-slate-900 rounded-3xl font-black text-indigo-400 border border-white/5" /> 
                                            <div className="grid grid-cols-2 gap-3"> 
                                                {sessionOrder.map(s => ( 
                                                    <button key={s} onClick={() => setSelectedSession(s)} className={`p-5 rounded-3xl text-[10px] font-black uppercase border transition-all ${selectedSession === s ? 'accent-gradient text-white border-transparent shadow-xl scale-105' : 'bg-slate-900 text-slate-600 border-white/5'}`}>{s}</button> 
                                                ))} 
                                            </div> 
                                            <button onClick={startWorkout} className="w-full py-8 accent-gradient text-white rounded-[2.5rem] font-black uppercase tracking-[0.4em] text-xs shadow-2xl active:scale-95 transition-all">Engage Lift</button> 
                                        </div> 
                                    </div> 
                                ) : ( 
                                    <div className="space-y-8"> 
                                        {/* SESSION METRICS */} 
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {currentWorkout.lastStats && ( 
                                                <div className="glass p-6 rounded-[2rem] space-y-3"> 
                                                    <div className="flex justify-between items-end"> 
                                                        <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Volume Parity</p> 
                                                        <p className="text-[10px] font-black text-white italic">{currentVolume} / {currentWorkout.lastStats.volume} kg</p> 
                                                    </div> 
                                                    <div className="h-2.5 bg-slate-800 rounded-full overflow-hidden shadow-inner"> 
                                                        <div className="h-full accent-gradient transition-all duration-700 ease-out" style={{width: `${Math.min(100, (currentVolume/currentWorkout.lastStats.volume)*100)}%`}} /> 
                                                    </div> 
                                                </div> 
                                            )}
                                            
                                            {/* FOCUS MODE TOGGLE */}
                                            {currentWorkout && (
                                                <button onClick={() => setFocusMode(!focusMode)} className={`col-span-2 p-4 rounded-2xl border transition-all flex items-center justify-center gap-2 ${focusMode ? 'bg-indigo-600 text-white border-transparent' : 'bg-slate-900 text-slate-500 border-white/5'}`}>
                                                    <Icon name="bolt" className="w-4 h-4" />
                                                    <span className="text-[9px] font-black uppercase tracking-widest">{focusMode ? 'Exit Focus Mode' : 'Enter Focus Mode'}</span>
                                                </button>
                                            )}

                                            {/* LIVE KINETIC IMPACT PANEL */}
                                            <div className="glass p-6 rounded-[2rem] space-y-3 col-span-2 md:col-span-2">
                                                <div className="flex justify-between items-end">
                                                    <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Live Kinetic Impact</p>
                                                    <p className="text-[10px] font-black text-white italic">Session Load</p>
                                                </div>
                                                <div className="space-y-2">
                                                    {(() => {
                                                        const sorted = calculateImpactDistribution(currentWorkout.exercises, true);
                                                        if (sorted.length === 0) return <span className="text-[9px] text-slate-600 font-bold uppercase tracking-widest italic">Start lifting to see impact data</span>;
                                                        
                                                        return sorted.map((d) => (
                                                            <div key={d.muscle} className="space-y-1">
                                                                <div className="flex justify-between text-[8px] font-black uppercase tracking-widest text-slate-400">
                                                                    <span>{d.muscle}</span>
                                                                    <span>{d.score}</span>
                                                                </div>
                                                                <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                                                    <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${d.pct}%`}} />
                                                                </div>
                                                            </div>
                                                        ));
                                                    })()}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {currentWorkout.exercises.map((ex, exIdx) => { 
                                            const prev = currentWorkout.exercises[exIdx-1]; 
                                            const stationChange = prev && normalizeStationName(prev.station) !== normalizeStationName(ex.station); 
                                            return ( 
                                                <div key={exIdx} id={`exercise-card-${exIdx}`} className="space-y-4 scroll-mt-32"> 
                                                    {stationChange && ( 
                                                        <div className="flex items-center gap-3 px-2 py-4"> 
                                                            <div className="h-0.5 flex-grow bg-indigo-500/50" />
                                                            <div className="p-2 bg-indigo-900/30 rounded-xl border border-indigo-500/30">
                                                                <span className="text-[10px] font-black text-indigo-300 uppercase tracking-[0.3em] italic">Station: {ex.station}</span>
                                                            </div>
                                                            <div className="h-0.5 flex-grow bg-indigo-500/50" /> 
                                                        </div> 
                                                    )} 
                                                    <div className={`glass rounded-[2.5rem] overflow-hidden border-t-4 transition-all duration-500 ${ex.sets.every(s => s.done) ? 'border-emerald-500 opacity-40 grayscale scale-[0.98]' : 'border-indigo-600 shadow-xl'}`}> 
                                                        <div className="p-8 space-y-6"> 
                                                            <div className="flex justify-between items-start"> 
                                                                <div className="space-y-2 max-w-[75%]"> 
                                                    <div className="flex gap-2 flex-wrap">
                                                        <span className="px-3 py-1 bg-indigo-900/40 text-indigo-400 text-[9px] font-black uppercase rounded-lg border border-indigo-500/20">{ex.station}</span> 
                                                        {ex.unilateral && (
                                                            <span className="px-3 py-1 bg-blue-900/40 text-blue-400 text-[9px] font-black uppercase rounded-lg border border-blue-500/20">Unilateral</span>
                                                        )}
                                                        {recoveryStatus.status !== 'Fried' && currentWorkout.laggingMuscle && ex.note.toLowerCase().includes(currentWorkout.laggingMuscle) && (
                                                            <span className="px-3 py-1 bg-yellow-900/40 text-yellow-400 text-[9px] font-black uppercase rounded-lg border border-yellow-500/20 glow-yellow animate-pulse">Kinetic Boost</span>
                                                        )}
                                                    </div>
                                                                    <h3 className="font-black text-xl text-white tracking-tighter italic leading-[1.1]">{cleanName(ex.name)}</h3> 
                                                    {(() => {
                                                        const att = getAttachment(ex.name, PRESETS);
                                                        return att ? (
                                                            <div className="flex items-center gap-2 py-1 px-2 bg-slate-800 rounded-lg border border-white/5 w-fit my-1">
                                                                <Icon name="tool" className="w-3 h-3 text-indigo-400" />
                                                                <span className="text-[8px] font-bold text-slate-400 uppercase tracking-wide">{att.name}</span>
                                                            </div>
                                                        ) : null;
                                                    })()}
                                                                    {ex.note && <p className="text-[9px] font-bold text-slate-400 leading-tight border-l-2 border-indigo-500 pl-2">{ex.note}</p>}
                                                                    <div className="flex items-center gap-4 group pt-2"> 
                                                                        <div className="flex items-center gap-2 flex-grow">
                                                                            <Icon name="tool" className="w-3.5 h-3.5 text-slate-500 group-hover:text-indigo-400 transition-colors" /> 
                                                                            
                                                                            <div className="flex flex-col flex-grow">
                                                                                {/* STRUCTURED SELECTOR */}
                                                                                <div className="flex gap-1 w-full">
                                                                                    <select 
                                                                                        value={ex.setup?.split('|')[0]?.trim() || ''} 
                                                                                        onChange={e => {
                                                                                            const currentLever = ex.setup?.split('|')[1]?.trim() || '-';
                                                                                            const newVal = `${e.target.value} | ${currentLever}`;
                                                                                            setSetupNotes({...setupNotes, [ex.name]: newVal}); 
                                                                                            const up = structuredClone(currentWorkout); up.exercises[exIdx].setup = newVal; setCurrentWorkout(up);
                                                                                        }}
                                                                                        className="bg-transparent text-[10px] font-bold text-indigo-300 border-none p-0 focus:ring-0 w-1/2 cursor-pointer"
                                                                                    >
                                                                                        <option value="">Seat</option>
                                                                                        {[1,2,3,4,5,6,7,8].map(n => <option key={n} value={`Seat ${n}`}>Seat {n}</option>)}
                                                                                    </select>
                                                                                    <span className="text-slate-600">|</span>
                                                                                    <select 
                                                                                        value={ex.setup?.split('|')[1]?.trim() || ''} 
                                                                                        onChange={e => {
                                                                                            const currentSeat = ex.setup?.split('|')[0]?.trim() || 'Seat -';
                                                                                            const newVal = `${currentSeat} | ${e.target.value}`;
                                                                                            setSetupNotes({...setupNotes, [ex.name]: newVal}); 
                                                                                            const up = structuredClone(currentWorkout); up.exercises[exIdx].setup = newVal; setCurrentWorkout(up);
                                                                                        }}
                                                                                        className="bg-transparent text-[10px] font-bold text-indigo-300 border-none p-0 focus:ring-0 w-1/2 cursor-pointer"
                                                                                    >
                                                                                        <option value="">Lever</option>
                                                                                        {['A','B','C','D','E'].map(l => <option key={l} value={`Lever ${l}`}>Lever {l}</option>)}
                                                                                    </select>
                                                                                </div>
                                                                                {/* TECH CUES FIELD */}
                                                                                <input 
                                                                                    type="text"
                                                                                    placeholder="Tech Cues (e.g. Chest up, slow eccentric)"
                                                                                    value={setupNotes[ex.name + "_cues"] || ""}
                                                                                    onChange={e => setSetupNotes({...setupNotes, [ex.name + "_cues"]: e.target.value})}
                                                                                    className="bg-transparent text-[9px] font-bold text-slate-500 border-none p-0 focus:ring-0 w-full placeholder:text-slate-700 italic"
                                                                                />
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            <button onClick={() => {
                                                                                const up = {...currentWorkout};
                                                                                const maxLoad = getLastMaxLoad(ex.name, logs);
                                                                                const warmUpKg = maxLoad > 0 ? (maxLoad * 0.5).toFixed(1) : '';
                                                                                up.exercises[exIdx].sets.unshift({ kg: warmUpKg, reps: '', rir: '', done: false, type: 'warmup' });
                                                                                setCurrentWorkout(up);
                                                                            }} className="px-3 py-1.5 bg-yellow-900/20 text-yellow-500 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-yellow-900/40 transition-colors border border-yellow-500/20">
                                                                                +Warmup
                                                                            </button>
                                                                            {ex.station.includes("Smith") && (
                                                                                <button onClick={() => setCalculatorTarget({ targetKg: ex.sets[0].kg || 20, barKg: 20 })} className="p-2 bg-indigo-900/20 rounded-lg text-indigo-400 hover:bg-indigo-900/40 transition-colors">
                                                                                    <Icon name="dumbbell" className="w-4 h-4" />
                                                                                </button>
                                                                            )}
                                                                            <button onClick={() => setSwappingIdx(exIdx)} className="p-2 bg-slate-800 rounded-lg text-slate-500 hover:text-indigo-400 hover:bg-slate-700 transition-colors border border-white/5">
                                                                                <Icon name="shuffle" className="w-4 h-4" />
                                                                            </button>
                                                                        </div>
                                                                    </div> 
                                                                </div> 
                                                                <a href={`https://www.youtube.com/results?search_query=TYTAX+T1+${encodeURIComponent(ex.name)}`} target="_blank" className="p-4 bg-slate-900 rounded-2xl text-slate-500 border border-white/5 hover:text-indigo-400 transition-colors"><Icon name="play" className="w-5 h-5"/></a> 
                                                            </div> 
                                                            <div className="space-y-3"> 
                                                                {ex.sets.map((set, sIdx) => {
                                                                    // GHOST REPS LOGIC
                                                                    const prevSession = logs.find(l => l.exercises.some(e => e.name === ex.name));
                                                                    let ghostReps = null;
                                                                    if (prevSession) {
                                                                        const prevEx = prevSession.exercises.find(e => e.name === ex.name);
                                                                        if (prevEx && prevEx.sets && prevEx.sets[sIdx]) {
                                                                            ghostReps = prevEx.sets[sIdx].reps;
                                                                        }
                                                                    }
                                                                    const beatGhost = ghostReps && set.reps && parseInt(set.reps) > parseInt(ghostReps);

                                                                    return (
                                                                    <div key={sIdx} className={`grid grid-cols-12 gap-2 items-center p-3 rounded-3xl transition-all relative overflow-hidden ${set.done ? 'bg-emerald-900/10' : set.type === 'warmup' ? 'bg-yellow-900/10 border border-yellow-500/10' : 'bg-slate-900/60'}`}> 
                                                                        {set.type === 'warmup' && <div className="absolute top-0 right-0 w-2 h-2 bg-yellow-500 rounded-bl-full" />}
                                                                        <div className={`col-span-1 text-center font-black text-[10px] ${set.type === 'warmup' ? 'text-yellow-600' : 'text-slate-700'}`}>{sIdx+1}</div> 
                                                                        <input id={`input-kg-${exIdx}-${sIdx}`} type="number" placeholder="KG" value={set.kg} disabled={set.done} onChange={e => { const up = {...currentWorkout}; up.exercises[exIdx].sets[sIdx].kg = e.target.value; setCurrentWorkout(up); }} className={`col-span-3 p-3 bg-black rounded-2xl font-black text-base text-center border-none text-white focus:ring-2 ${set.type === 'warmup' ? 'focus:ring-yellow-500' : 'focus:ring-indigo-500'}`} /> 
                                                                        <div className="col-span-3 relative">
                                                                            <input id={`input-reps-${exIdx}-${sIdx}`} type="number" placeholder={ghostReps ? `Ghost: ${ghostReps}` : "R"} value={set.reps} disabled={set.done} onChange={e => { const up = {...currentWorkout}; up.exercises[exIdx].sets[sIdx].reps = e.target.value; setCurrentWorkout(up); }} className={`w-full p-3 bg-black rounded-2xl font-black text-base text-center border-none focus:ring-2 ${set.type === 'warmup' ? 'focus:ring-yellow-500' : 'focus:ring-indigo-500'} ${beatGhost ? 'text-emerald-400 font-bold' : 'text-white'}`} /> 
                                                                             {ex.unilateral && <span className="absolute right-1 bottom-1 text-[8px] font-bold text-slate-600">/side</span>}
                                                                        </div>
                                                                        <div className="col-span-2 flex flex-col gap-1">
                                                                            <select value={set.rir} disabled={set.done} onChange={e => { const up = {...currentWorkout}; up.exercises[exIdx].sets[sIdx].rir = e.target.value; setCurrentWorkout(up); }} className="bg-slate-800 text-indigo-400 text-[9px] font-black rounded-lg p-1 text-center border-none">
                                                                                <option value="">RIR</option>
                                                                                {[0,1,2,3,4].map(r => <option key={r} value={r}>{r}</option>)}
                                                                            </select>
                                                                            <span className="text-[8px] font-black text-slate-600 text-center">1RM: {calculateE1RM(set.kg, set.reps)}</span>
                                                                        </div>
                                                                        <button disabled={!set.kg || !set.reps || set.done} onClick={() => {
                                                                            const up = {...currentWorkout}; up.exercises[exIdx].sets[sIdx].done = true; setCurrentWorkout(up); setTimer(90); setTimerActive(true);
                                                                            if (window.navigator.vibrate) window.navigator.vibrate(50);
                                                                            
                                                                            // IMPACT PULSE
                                                                            const card = document.getElementById(`exercise-card-${exIdx}`);
                                                                            if (card) {
                                                                                card.classList.add('glow-indigo');
                                                                                setTimeout(() => card.classList.remove('glow-indigo'), 1000);
                                                                            }

                                                                            // Smart Focus Logic
                                                                            setTimeout(() => {
                                                                                const nextSet = document.getElementById(`input-kg-${exIdx}-${sIdx+1}`);
                                                                                const nextExInput = document.getElementById(`input-kg-${exIdx+1}-0`);
                                                                                const nextExCard = document.getElementById(`exercise-card-${exIdx+1}`);

                                                                                if (nextSet) {
                                                                                    nextSet.focus();
                                                                                    nextSet.select();
                                                                                    nextSet.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                                                }
                                                                                else if (nextExInput) {
                                                                                    nextExInput.focus();
                                                                                    nextExInput.select();
                                                                                    if (nextExCard) {
                                                                                        nextExCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                                                    } else {
                                                                                        nextExInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                                                    }
                                                                                }
                                                                            }, 100);
                                                                        }} className={`col-span-2 p-4 rounded-2xl flex items-center justify-center transition-all ${set.done ? 'bg-emerald-500 text-white shadow-lg' : 'bg-slate-800 text-slate-600 active:scale-90 disabled:opacity-20'}`}><Icon name="check" className="w-5 h-5" /></button>
                                                                        <button onClick={() => {
                                                                            if (confirm("Delete this set?")) {
                                                                                const newWorkout = structuredClone(currentWorkout);
                                                                                newWorkout.exercises[exIdx].sets.splice(sIdx, 1);
                                                                                setCurrentWorkout(newWorkout);
                                                                            }
                                                                        }} className="col-span-1 h-12 rounded-2xl flex items-center justify-center transition-all bg-red-900/20 text-red-500 hover:bg-red-500 hover:text-white active:scale-90 border border-red-500/20"><Icon name="trash" className="w-4 h-4" /></button>
                                                                    </div>
                                                                );
                                                                })}
                                                                <button onClick={() => {
                                                                    const up = {...currentWorkout};
                                                                    const lastKg = up.exercises[exIdx].sets[up.exercises[exIdx].sets.length-1]?.kg || '';
                                                                    up.exercises[exIdx].sets.push({ kg: lastKg, reps: '', rir: '', done: false, type: 'working' });
                                                                    setCurrentWorkout(up);
                                                                }} className="w-full py-3 bg-slate-900 rounded-2xl border border-white/5 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-white hover:border-white/10 transition-colors">+ Add Working Set</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        </div>
                                        <button onClick={() => {
                                            setDebriefData({ workout: currentWorkout, duration: stopwatch, volume: currentVolume });
                                        }} className="w-full py-8 accent-gradient text-white rounded-[3rem] font-black uppercase shadow-2xl tracking-[0.4em] text-xs">Terminate Session</button>
                                    </div>
                                )}
                            </div>
                        )} 
 
                        {activeTab === 'trends' && ( 
                            <div className="tab-content space-y-10 pb-20"> 
                                <h2 className="text-4xl font-black tracking-tighter px-2 italic uppercase leading-[0.9]">Force<br/><span className="text-indigo-500">Output</span></h2> 
                                
                                {/* TROPHY CASE */}
                                <div className="grid grid-cols-3 gap-3">
                                    {['Squat', 'Bench', 'Deadlift'].map(lift => {
                                        // Find best e1RM for any exercise matching the pattern
                                        let best = 0;
                                        logs.forEach(l => {
                                            l.exercises.forEach(e => {
                                                if (e.name.toLowerCase().includes(lift.toLowerCase())) {
                                                    const maxE1RM = Math.max(...e.sets.map(s => calculateE1RM(s.kg, s.reps)));
                                                    if (maxE1RM > best) best = maxE1RM;
                                                }
                                            })
                                        });
                                        return (
                                            <div key={lift} className="glass p-6 rounded-[2rem] text-center space-y-2">
                                                <Icon name="bolt" className="w-6 h-6 mx-auto text-yellow-500" />
                                                <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">{lift}</p>
                                                <p className="text-2xl font-black text-white italic">{best}<span className="text-[10px] text-slate-600 ml-1">KG</span></p>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* Work Capacity / Density Chart */}
                                {logs.length > 1 && (
                                    <div className="glass p-8 rounded-[3rem] space-y-6">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-black text-xl text-white leading-none tracking-tighter italic">Work Capacity</h3>
                                            <span className="text-[8px] font-black text-emerald-500 uppercase tracking-widest">Density (KG/Min)</span>
                                        </div>
                                        <ProgressGraph data={logs.slice().reverse().map(l => ({
                                            date: new Date(l.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}),
                                            value: Math.round((l.volume || 0) / Math.max(1, (l.duration || 60) / 60))
                                        })).slice(-10)} color="#10b981" label="Density" />
                                    </div>
                                )}

                                {/* Bodyweight Tracker */}
                                <div className="glass p-8 rounded-[3rem] space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-black text-xl text-white leading-none tracking-tighter italic">Bodyweight</h3>
                                        <button onClick={() => {
                                            const w = prompt("Log current bodyweight:");
                                            if (w && !isNaN(w)) setBodyweightLog([...bodyweightLog, { date: new Date().toISOString().split('T')[0], value: parseFloat(w) }]);
                                        }} className="text-[8px] font-black bg-indigo-900/30 text-indigo-400 px-3 py-2 rounded-lg uppercase tracking-widest hover:bg-indigo-900/50">+ Log</button>
                                    </div>
                                    <ProgressGraph data={bodyweightLog.length > 0 ? bodyweightLog : [{date: 'Now', value: userProfile?.bodyweight || 0}]} color="#f59e0b" label="KG" />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {masterExercises.map(ex => { 
                                    const exLogs = logs.filter(l => l.exercises.some(e => e.name === ex.name)).reverse(); 
                                    const chartData = exLogs.map(l => { 
                                        const sessionEx = l.exercises.find(e => e.name === ex.name); 
                                        const bestE1RM = Math.max(...sessionEx.sets.map(s => calculateE1RM(s.kg, s.reps))); 
                                        return { date: new Date(l.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}), value: bestE1RM.toFixed(1) }; 
                                    }); 
                                    if (!chartData.length) return null; 
                                    return ( 
                                        <div key={ex.name} className="glass p-8 rounded-[3rem] space-y-6"> 
                                            <div className="flex justify-between items-center"> 
                                                <h3 className="font-black text-xl text-white leading-none tracking-tighter italic">{cleanName(ex.name)}</h3> 
                                                <span className="text-[8px] font-black text-indigo-500 uppercase tracking-widest">{ex.station}</span> 
                                            </div> 
                                            <ProgressGraph data={chartData} label="e1RM" /> 
                                        </div> 
                                    ); 
                                })} 
                                </div>
                                {logs.length === 0 && <div className="py-40 text-center opacity-20"><Icon name="trends" className="w-12 h-12 mx-auto" /><p className="text-[10px] font-black uppercase mt-4 tracking-[0.3em]">No data records</p></div>} 
                            </div> 
                        )} 
 
                        {activeTab === 'history' && ( 
                            <div className="tab-content space-y-6 pb-20"> 
                                <h2 className="text-4xl font-black tracking-tighter px-2 italic uppercase leading-[0.9]">Archive<br/><span className="text-indigo-500">Vault</span></h2> 
                                {logs.length === 0 ? ( 
                                    <div className="py-40 text-center opacity-20"><Icon name="history" className="w-12 h-12 mx-auto" /><p className="text-[10px] font-black uppercase mt-4 tracking-[0.3em]">Vault is empty</p></div> 
                                ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {logs.map(log => ( 
                                    <div key={log.id} className="glass p-8 rounded-[2.5rem] relative group border-white/5"> 
                                        <div className="flex justify-between items-start mb-6"> 
                                            <div> 
                                                <span className="px-4 py-1 accent-gradient rounded-full text-[9px] font-black uppercase tracking-widest text-white shadow-lg">{log.session}</span> 
                                                <h3 className="font-black text-2xl mt-3 text-white tracking-tighter leading-none italic">{new Date(log.date).toDateString()}</h3> 
                                                <p className="text-[10px] font-black text-slate-500 mt-2 uppercase tracking-widest italic">{Math.floor(log.duration/60)}m duration â€¢ {log.volume || 0}kg total</p> 
                                            </div> 
                                            <div className="flex gap-2">
                                                <button onClick={() => setEditingLog(log)} className="p-3 bg-slate-800 text-slate-400 hover:text-white transition-colors rounded-xl"><Icon name="tool" className="w-4 h-4" /></button>
                                                <button onClick={() => { if(confirm("Delete entry?")) setLogs(logs.filter(l => l.id !== log.id)); }} className="p-3 bg-red-900/10 text-red-900 hover:text-red-500 transition-colors rounded-xl"><Icon name="x" className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                        <div className="space-y-4 border-t border-white/5 pt-6">
                                            {/* SESSION IMPACT SUMMARY */}
                                            <div className="space-y-2">
                                                <p className="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Kinetic Impact</p>
                                                {(() => {
                                                    const sorted = calculateImpactDistribution(log.exercises, true);
                                                    return sorted.map((d) => (
                                                        <div key={d.muscle} className="space-y-1">
                                                            <div className="flex justify-between text-[8px] font-black uppercase tracking-widest text-slate-500">
                                                                <span>{d.muscle}</span>
                                                                <span>{d.score}</span>
                                                            </div>
                                                            <div className="h-1 bg-slate-800 rounded-full overflow-hidden">
                                                                <div className="h-full bg-slate-500" style={{width: `${d.pct}%`}} />
                                                            </div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                            <div className="h-px bg-white/5" />
                                            {log.exercises.map((ex, i) => ( 
                                                <div key={i} className="flex justify-between items-center text-xs"> 
                                                    <span className="font-bold text-slate-500 uppercase text-[10px] tracking-tight">{cleanName(ex.name)}</span> 
                                                    <span className="text-indigo-400 font-black italic">{Math.max(...ex.sets.map(s => parseFloat(s.kg)||0))}kg</span> 
                                                </div> 
                                            ))} 
                                        </div>
                                    </div>
                                ))}
                                </div>
                                )}
                            </div>
                        )}

                        {/* BUILDER TAB */}
                        {activeTab === 'builder' && (
                            <BuilderTab 
                                metaLibrary={library}
                                userInventory={userInventory}
                                onSave={(newProtocol) => {
                                    const updated = [...customProtocols, newProtocol];
                                    setCustomProtocols(updated);
                                    localStorage.setItem('tytax_custom_protocols', JSON.stringify(updated));

                                    loadPreset(newProtocol); // Load it immediately
                                    setActiveTab('home'); // Go to Home to see it active
                                    showToast(`Protocol "${newProtocol.name}" Created`);
                                }}
                                onCancel={() => setActiveTab('home')}
                            />
                        )}

                        {/* FEATURES TAB */}
                        {activeTab === 'features' && (
                            <div className="tab-content space-y-8 pb-20">
                                <h2 className="text-4xl font-black tracking-tighter px-2 italic uppercase leading-[0.9]">System<br/><span className="text-indigo-500">Manual</span></h2>
                                
                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="trends" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Kinetic Impact</h3>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed font-medium">A real-time visual representation of muscle stimulation based on the Tomi Kinetic Impact protocol. The app parses exercise notes for "Primary," "Secondary," and "Tertiary" muscle groups to visualize your training balance.</p>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="bolt" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Volume Parity</h3>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed font-medium">An automated progressive overload monitor. The system compares your current session's total weight (KG Ã— Reps) against your last performance. Reach 100% to exceed your previous best.</p>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="dumbbell" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Smart Logic</h3>
                                    </div>
                                    <ul className="space-y-4">
                                        <li className="space-y-1">
                                            <span className="text-[10px] font-black text-white uppercase tracking-widest block">Auto-Warmups</span>
                                            <span className="text-xs text-slate-500 font-medium">Uses historical max load to suggest 50% and 75% warmup sets.</span>
                                        </li>
                                        <li className="space-y-1">
                                            <span className="text-[10px] font-black text-white uppercase tracking-widest block">e1RM Calculation</span>
                                            <span className="text-xs text-slate-500 font-medium">Every set calculates an Estimated 1-Rep Max to track strength gains without failure testing.</span>
                                        </li>
                                        <li className="space-y-1">
                                            <span className="text-[10px] font-black text-white uppercase tracking-widest block">RIR Logging</span>
                                            <span className="text-xs text-slate-500 font-medium">Track Reps In Reserve (0-4). 0 RIR means absolute failure.</span>
                                        </li>
                                    </ul>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="tool" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Station Aware</h3>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed font-medium">The app detects station changes (e.g., Smith Machine to Lat Station) and provides visual dividers. Use the Dumbbell Icon on Smith exercises to open the Plate Loader tool.</p>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="shield" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Biometric Status</h3>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center text-xs font-bold text-slate-500"><span className="text-emerald-500">Fresh</span> <span>ACWR &lt; 1.5</span></div>
                                        <div className="flex justify-between items-center text-xs font-bold text-slate-500"><span className="text-yellow-500">Recovering</span> <span>ACWR 1.5 - 2.0</span></div>
                                        <div className="flex justify-between items-center text-xs font-bold text-slate-500"><span className="text-red-500">Fried</span> <span>ACWR &gt; 2.0 (Deload recommended)</span></div>
                                    </div>
                                    <p className="text-[10px] text-slate-600 mt-4 leading-relaxed">The system uses the <strong>Acute:Chronic Workload Ratio (ACWR)</strong> with <strong>Time-Decay</strong>. Stress from 48h ago counts less than stress from 2h ago. This ensures the status reflects your <em>current</em> readiness.</p>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="info" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Gap Analysis</h3>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed font-medium">Every 7 days, the app compares actual performance against the protocol's ideal distribution. If you are <span className="text-emerald-500 font-bold">Fresh</span>, neglected muscles trigger a <span className="text-yellow-400 font-bold">Glow-Yellow</span> reminder to add volume.</p>
                                </div>

                                <div className="glass p-8 rounded-[3rem] space-y-6 border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-indigo-900/20 rounded-2xl text-indigo-400"><Icon name="library" className="w-5 h-5" /></div>
                                        <h3 className="text-xl font-black italic uppercase text-white tracking-tighter">Meta-Library Support</h3>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed font-medium">The system now supports structured exercise data. This allows for "Pattern Swapping" (e.g., replacing one Chest Press with another while maintaining the same Kinetic Impact) and "Attachment Tracking" to streamline your Tytax setup.</p>
                                </div>
                            </div>
                        )}
 
                        {activeTab === 'settings' && ( 
                            <div className="tab-content space-y-10 pb-20"> 
                                <h2 className="text-4xl font-black tracking-tighter px-2 italic uppercase leading-[0.9]">Master<br/><span className="text-indigo-500">Node</span></h2> 
                                <div className="glass p-10 rounded-[3rem] space-y-10 border-white/5"> 
                                    <div className="space-y-4"> 
                                        <div className="flex items-center gap-3"><Icon name="bolt" className="text-indigo-500 w-5 h-5" /><h3 className="font-black text-white uppercase text-xs tracking-widest">Protocol Ingestion</h3></div> 
                                        <textarea value={libraryInput} onChange={e => setLibraryInput(e.target.value)} placeholder='Paste JSON protocol here...' className="w-full h-40 bg-black p-6 rounded-[2rem] text-[10px] font-mono border border-white/5 text-indigo-300 focus:ring-1 focus:ring-indigo-500 no-scrollbar" /> 
                                        <button onClick={importJSON} className="w-full py-5 accent-gradient text-white rounded-[2rem] font-black text-xs uppercase shadow-2xl tracking-[0.3em]">Inject JSON</button> 
                                    </div> 
                                    <div className="h-px bg-white/5" /> 
                                    <div className="grid grid-cols-1 gap-6"> 
                                        {/* INVENTORY LOCKER */}
                                        <div className="space-y-4">
                                            <div className="flex items-center gap-3"><Icon name="tool" className="text-indigo-500 w-5 h-5" /><h3 className="font-black text-white uppercase text-xs tracking-widest">Inventory Locker</h3></div>
                                            <div className="grid grid-cols-2 gap-2">
                                                {PRESETS[0].data.RECOMMENDED_ATTACHMENTS.map(att => (
                                                    <button key={att.name} onClick={() => { if (userInventory.includes(att.name)) setUserInventory(userInventory.filter(i => i !== att.name)); else setUserInventory([...userInventory, att.name]); }} className={`p-3 rounded-xl text-[9px] font-bold text-left transition-all ${userInventory.includes(att.name) ? 'bg-indigo-900/30 text-indigo-400 border border-indigo-500/30' : 'bg-slate-900 text-slate-600 border border-white/5'}`}>
                                                        {userInventory.includes(att.name) ? 'âœ“ ' : 'â—‹ '} {att.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="h-px bg-white/5" />

                                        <div className="flex justify-between items-center px-2"> 
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Rotation Epoch</label> 
                                            <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="bg-transparent font-black text-indigo-500 border-none text-right focus:ring-0" /> 
                                        </div>
                                        <div className="flex justify-between items-center px-2"> 
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Warmup Strategy</label> 
                                            <select value={warmupStrategy} onChange={e => setWarmupStrategy(e.target.value)} className="bg-transparent font-black text-indigo-500 border-none text-right focus:ring-0 uppercase text-[10px]">
                                                <option value="Standard">Standard</option>
                                                <option value="Heavy">Heavy (Potentiation)</option>
                                                <option value="Pyramid">Pyramid (Volume)</option>
                                            </select>
                                        </div>
                                        <div className="flex justify-between items-center px-2"> 
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">OLED Pure Black</label> 
                                            <button onClick={() => setOledMode(!oledMode)} className={`w-12 h-6 rounded-full transition-colors relative ${oledMode ? 'bg-indigo-500' : 'bg-slate-800'}`}>
                                                <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${oledMode ? 'translate-x-6' : 'translate-x-0'}`} />
                                            </button>
                                        </div> 
                                        <div className="flex gap-4"> 
                                            <button onClick={exportCSV} className="flex-grow p-6 bg-slate-900 rounded-[2rem] font-black text-[10px] uppercase flex items-center justify-center gap-3 text-emerald-400 border border-white/5 hover:text-white transition-colors">Export CSV</button>
                                            <button onClick={() => { 
                                                const blob = new Blob([JSON.stringify({ logs, sessionOrder, trainingPlan, masterExercises, startDate, setupNotes, oledMode, userInventory, userProfile, customProtocols, warmupStrategy })], { type: 'application/json' }); 
                                                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "tytax_backup.json"; a.click(); 
                                            }} className="flex-grow p-6 bg-slate-900 rounded-[2rem] font-black text-[10px] uppercase flex items-center justify-center gap-3 text-slate-400 border border-white/5 hover:text-white transition-colors"><Icon name="history" /> Backup</button> 
                                            <label className="flex-grow p-6 bg-slate-900 rounded-[2rem] font-black text-[10px] uppercase flex items-center justify-center gap-3 text-indigo-400 border border-white/5 cursor-pointer hover:bg-indigo-900/10 transition-colors"> 
                                                <Icon name="library" /> Import <input type="file" onChange={(e) => { 
                                                    const f = e.target.files[0]; const r = new FileReader(); 
                                                    r.onload = (ev) => { 
                                                        try {
                                                            const d = JSON.parse(ev.target.result); 
                                                            if (!d.logs && !d.sessionOrder) throw new Error("Invalid Format");
                                                            
                                                            setLogs(d.logs || []); 
                                                            setMasterExercises(d.masterExercises || []); 
                                                            setTrainingPlan(d.trainingPlan || {}); 
                                                            setSessionOrder(d.sessionOrder || []); 
                                                            setStartDate(d.startDate || startDate); 
                                                            setSetupNotes(d.setupNotes || {}); 
                                                            if (d.oledMode !== undefined) setOledMode(d.oledMode);
                                                            if (d.userInventory) setUserInventory(d.userInventory);
                                                            if (d.userProfile) setUserProfile(d.userProfile);
                                                            if (d.customProtocols) setCustomProtocols(d.customProtocols);
                                                            if (d.warmupStrategy) setWarmupStrategy(d.warmupStrategy);
                                                            
                                                            showToast("Vault Restored"); 
                                                        } catch(err) {
                                                            alert("Restore Failed: Invalid Backup File");
                                                        }
                                                    }; r.readAsText(f); 
                                                }} className="hidden" /> 
                                            </label> 
                                        </div> 
                                    </div> 
                                    <button onClick={() => { if(confirm("Purge system?")) { localStorage.clear(); window.location.reload(); } }} className="w-full text-red-900 hover:text-red-500 py-4 font-black text-[10px] uppercase tracking-[0.4em] transition-colors">Emergency Purge</button> 
                                </div> 
                            </div> 
                        )} 
                    </main> 
 
                    {/* MOBILE NAV (Visible < md) */} 
                    {!focusMode && (
                        <nav className="md:hidden fixed bottom-8 left-8 right-8 glass text-white rounded-[3rem] flex justify-around p-3 shadow-[0_20px_50px_rgba(0,0,0,0.5)] z-40 border-white/5"> 
                            {[ 
                                { id: 'home', icon: 'home', label: 'Home' }, 
                                { id: 'workout', icon: 'bolt', label: 'Gym' }, 
                                { id: 'trends', icon: 'trends', label: 'Trends' }, 
                                { id: 'history', icon: 'history', label: 'Vault' },
                                { id: 'builder', icon: 'tool', label: 'Builder' },
                                { id: 'features', icon: 'info', label: 'Features' }
                            ].map(tab => ( 
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 px-6 py-4 rounded-[2.5rem] transition-all duration-700 ${activeTab === tab.id ? 'accent-gradient scale-110 shadow-2xl' : 'text-slate-600 hover:text-slate-400'}`}> 
                                    <Icon name={tab.icon} className="w-6 h-6" /><span className="text-[7px] font-black uppercase tracking-[0.2em]">{tab.label}</span> 
                                </button> 
                            ))} 
                        </nav> 
                    )}
                </div> 
            ); 
        }; 
 
        const root = ReactDOM.createRoot(document.getElementById('root')); 
        root.render(<ErrorBoundary><App /></ErrorBoundary>); 
    </script> 
</body> 
</html>
